<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portuguese Language Drills</title>
    <!-- Force deployment update -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        .drill-card {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.3s ease-out, transform 0.3s ease-in-out, box-shadow 0.3s ease;
        }
        .drill-card.hidden {
            visibility: hidden;
            opacity: 0;
            position: absolute; /* Take it out of the flow to prevent empty space */
            transform: scale(0.95);
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .drill-card.highlight {
            box-shadow: 0 0 0 3px #3b82f6; /* blue-500 */
            transform: translateY(-4px) scale(1.02);
        }
        /* FIX: Add a specific style for a card that is both highlighted and hovered */
        .drill-card.highlight:hover {
            box-shadow: 0 0 0 3px #3b82f6, 0 25px 50px -12px rgb(0 0 0 / 0.25); /* Combines blue ring with shadow-2xl */
            transform: translateY(-6px) scale(1.03); /* A slightly more pronounced effect */
        }
        #path-display-container .learning-path {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .learning-path ol {
            position: relative;
            padding-left: 2rem;
            list-style: none;
        }
        
        .learning-path > ol > li {
            position: relative;
            padding-bottom: 1.5rem; 
        }
        .learning-path > ol > li:last-child {
            padding-bottom: 0;
        }
        
        /* Node style (the circle) for TOP-LEVEL items only */
        .learning-path > ol > li::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 0.4rem;
            width: 1rem;
            height: 1rem;
            border-radius: 9999px;
            background-color: #fff;
            border: 3px solid #6366f1; /* indigo-600 */
            z-index: 1;
        }

        /* Connecting line for TOP-LEVEL items only */
        .learning-path > ol > li::after {
            content: '';
            position: absolute;
            left: -1.2rem;
            top: 0.5rem;
            bottom: -0.5rem; 
            width: 2px;
            background-color: #6366f1; /* Solid indigo for core path */
        }
        
        .learning-path > ol > li:last-child::after {
            display: none;
        }

        /* Style for supplemental path nodes (TOP-LEVEL) */
        .learning-path > ol > li.supplemental-step::before {
            background-color: #f8fafc; /* bg-slate-50 */
            border: 2px dashed #94a3b8; /* slate-400 */
        }
        
        .learning-path > ol > li.supplemental-step::after {
            background-image: linear-gradient(to bottom, #94a3b8 60%, transparent 40%);
            background-size: 2px 8px;
            background-repeat: repeat-y;
            background-color: transparent; /* Remove solid color */
        }

        /* NEW: Styles for Learning Bundles */
        .learning-bundle {
            background-color: #f8fafc; /* slate-50 */
            border: 1px solid #e2e8f0; /* slate-200 */
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .learning-bundle-title {
            font-weight: 600;
            color: #475569; /* slate-600 */
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12 sm:py-16 flex-grow">
        
        <header class="text-center mb-12">
            <div class="py-10 px-4 bg-gradient-to-br from-white to-slate-100 rounded-3xl shadow-sm">
                <h1 class="text-4xl sm:text-5xl font-bold tracking-tight text-slate-900">Portuguese Language Drills</h1>
                <p class="mt-4 max-w-3xl mx-auto text-lg text-slate-600">
                    Start a fresh new session, or choose from the drill cards.
                </p>
                <div class="mt-6">
                    <button onclick="startEmptySession()" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg">
                        Start Empty Session
                    </button>
                </div>
            </div>
        </header>

        <!-- A1 Text Simplifier Section -->
        <section class="mb-12">
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-3xl shadow-lg p-6 sm:p-8">
                <button
                    onclick="toggleSimplifier()"
                    class="w-full flex items-center justify-between text-left focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"
                >
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">A1 Text Simplifier</h2>
                            <p class="text-slate-600 text-sm mt-1">Convert any Portuguese text to A1 beginner level</p>
                        </div>
                    </div>
                    <svg id="simplifier-chevron" class="w-6 h-6 text-slate-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div id="simplifier-content" class="hidden mt-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Section -->
                        <div>
                            <label for="simplifier-input" class="block text-sm font-semibold text-slate-700 mb-2">
                                Original Portuguese Text
                            </label>
                            <textarea
                                id="simplifier-input"
                                rows="8"
                                class="w-full px-4 py-3 text-slate-900 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="Cole ou digite o texto em portuguÃªs aqui..."
                            ></textarea>
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-xs text-slate-500">Paste any Portuguese text you want to simplify</span>
                                <button
                                    onclick="simplifyText()"
                                    id="simplify-btn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Simplify to A1
                                </button>
                            </div>
                        </div>

                        <!-- Output Section -->
                        <div>
                            <label for="simplifier-output" class="block text-sm font-semibold text-slate-700 mb-2">
                                Simplified A1-Level Portuguese
                            </label>
                            <div
                                id="simplifier-output"
                                class="w-full h-48 px-4 py-3 text-slate-900 bg-white border border-slate-300 rounded-lg shadow-sm overflow-y-auto"
                            >
                                <div class="flex items-center justify-center h-full text-slate-400">
                                    <div class="text-center">
                                        <svg class="w-16 h-16 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <p class="text-sm">Simplified text will appear here</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-end gap-2">
                                <button
                                    onclick="copySimplifiedText()"
                                    id="copy-btn"
                                    class="hidden bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium px-4 py-2 rounded-lg transition-colors text-sm"
                                >
                                    Copy Text
                                </button>
                                <button
                                    onclick="clearSimplifier()"
                                    class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium px-4 py-2 rounded-lg transition-colors text-sm"
                                >
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Hidden templates for the learning paths -->
        <div id="path-templates" class="hidden">
            <div id="a1-path" class="learning-path bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b-2 border-indigo-200 pb-3">A1 Path</h3>
                <ol>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-self-introduction">Self-Introduction Drill</a></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Regular Verbs</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-ar-verbs">Regular -ar Verbs</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-er-verbs">Regular -er Verbs</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-ir-verbs">Regular -ir Verbs</a></li></ul></div></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-irregular-verbs">Irregular Verbs Drill</a></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-contractions-articles">Contractions with Articles (de/em)</a></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Core Concepts</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-immediate-future">Immediate Future</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-noun-plurals">Noun Plurals</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-adjective-agreement">Adjective Agreement</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-ir-transportation">'Ir' + Transportation</a></li></ul></div></li>
                </ol>
            </div>
            <div id="a2-path" class="learning-path bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b-2 border-indigo-200 pb-3">A2 Path</h3>
                <ol>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-reflexive-verbs">Reflexive Verbs Drill</a></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Contractions w/ Pronouns</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-contractions-de">Contractions (de + pronouns)</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-contractions-em">Contractions (em + pronouns)</a></li></ul></div></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-present-continuous">Present Continuous Tense</a></li>
                    <li class="supplemental-step"><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-conversational-answers">Supplemental: Conversational Answers</a></li>
                </ol>
            </div>
            <div id="b1-path" class="learning-path bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b-2 border-indigo-200 pb-3">B1 Path</h3>
                <ol>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Past & Future Tenses</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-imperfect-tense">Imperfect Tense</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-future-tense">Future Tense</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-conditional-tense">Conditional Tense</a></li></ul></div></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Key Grammar</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-crase">Crase (Ã ) Tutor</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-demonstratives">Demonstratives</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-imperative">Imperative (Commands)</a></li></ul></div></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-present-subjunctive">Present Subjunctive Drill</a></li>
                    <li class="supplemental-step"><div class="learning-bundle"><h4 class="learning-bundle-title italic">Supplemental Bundle</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-syllable-stress">Syllable Stress</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-portuguese-for-spanish">For Spanish Speakers</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-grammar-for-spanish">Grammar for Spanish Speakers</a></li></ul></div></li>
                </ol>
            </div>
            <div id="b2-path" class="learning-path bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b-2 border-indigo-200 pb-3">B2 Path</h3>
                <ol>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Advanced Subjunctive</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-imperfect-subjunctive">Imperfect Subjunctive</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-future-subjunctive">Future Subjunctive</a></li></ul></div></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-advanced-demonstratives">Advanced Demonstratives Drill</a></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Sounding Natural</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-colloquial-speech">Colloquial Speech</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-phonetic-tutor">Phonetic Tutor</a></li></ul></div></li>
                </ol>
            </div>
        </div>

        <main>
            <!-- Search Bar -->
            <div class="my-8 max-w-md mx-auto">
                <label for="search-input" class="sr-only">Search for a drill</label>
                <input type="text" id="search-input" placeholder="Search for a drill..." class="w-full px-5 py-3 text-lg text-slate-700 bg-white border border-slate-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Topic Filter Controls -->
            <div id="topic-filter-controls" class="flex justify-center items-center gap-x-2 sm:gap-x-3 gap-y-2 mb-4 flex-wrap">
                 <span class="font-semibold text-slate-600">Topic:</span>
                 <button data-filter="all" class="topic-filter-btn active bg-blue-600 text-white rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="true">All</button>
                 <button data-filter="verbs" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Core Verbs</button>
                 <button data-filter="tenses" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Tenses & Structures</button>
                 <button data-filter="grammar" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Grammar & Prepositions</button>
                 <button data-filter="pronunciation" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Pronunciation</button>
                 <button data-filter="conversation" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Conversational Skills</button>
            </div>

            <!-- CEFR Level Filter Controls -->
            <div id="cefr-filter-controls" class="flex justify-center items-center gap-x-2 sm:gap-x-3 gap-y-2 mb-6 flex-wrap">
                 <span class="font-semibold text-slate-600">CEFR Level:</span>
                 <button data-filter="all" class="cefr-filter-btn active bg-indigo-600 text-white rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="true">All</button>
                 <button data-filter="a1" class="cefr-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="false">A1</button>
                 <button data-filter="a2" class="cefr-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="false">A2</button>
                 <button data-filter="b1" class="cefr-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="false">B1</button>
                 <button data-filter="b2" class="cefr-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="false">B2</button>
            </div>

            <!-- Container for Path buttons and the dynamic display area -->
            <section id="learning-paths-section" class="mb-12">
                <!-- The buttons that trigger the paths -->
                <div id="path-triggers" class="flex justify-center items-center gap-x-2 sm:gap-x-3 gap-y-2 mb-6 flex-wrap">
                    <span class="font-semibold text-slate-600">Learning Paths:</span>
                    <button data-path-id="a1-path" class="path-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">A1 Path</button>
                    <button data-path-id="a2-path" class="path-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">A2 Path</button>
                    <button data-path-id="b1-path" class="path-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">B1 Path</button>
                    <button data-path-id="b2-path" class="path-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">B2 Path</button>
                </div>
                
                <!-- This container will be populated by JavaScript when a button is clicked -->
                <div id="path-display-container" class="min-h-[1rem]"></div>
            </section>

            <!-- Drill Cards Grid -->
            <div id="drill-grid" class="relative grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div id="drill-ar-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Regular `-ar` Verb Drill</h2><p class="text-slate-600 text-base flex-grow">Practice the present and simple past of `-ar` verbs.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c11437be1881918610dff3e74a6301-regular-ar-verb-tutor" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('regular-ar')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('regular-ar', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-er-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Regular `-er` Verb Drill</h2><p class="text-slate-600 text-base flex-grow">Practice the present and simple past of `-er` verbs.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c1175a9b3c8191a0d9f534de01a2d7-regular-er-verb-tutor" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('regular-er')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('regular-er', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-ir-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Regular `-ir` Verb Drill</h2><p class="text-slate-600 text-base flex-grow">Practice the present and simple past of `-ir` verbs.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c1183593308191b3992e8d2ef9324e-regular-ir-verb-tutor" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('regular-ir')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('regular-ir', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-irregular-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Irregular Verb Drill</h2><p class="text-slate-600 text-base flex-grow">Memorize the forms for the most important irregular verbs (ser, estar, ir, ter, etc.).</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c1228bde248191902a423b11197f1f-irregular-verb-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('irregular-verbs')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('irregular-verbs', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-ser-estar" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Ser vs. Estar Drill</h2><p class="text-slate-600 text-base flex-grow">Master the fundamental difference between `ser` (permanent/identity) and `estar` (temporary/location/condition).</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="#" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('ser-estar')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('ser-estar', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-reflexive-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Reflexive Verbs Drill</h2><p class="text-slate-600 text-base flex-grow">Practice choosing the correct reflexive pronoun (`me`, `se`, `nos`) to match the subject.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c1d82c6f348191a9be65fe79b8a8d7-reflexive-verbs-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('reflexive-verbs')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('reflexive-verbs', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-immediate-future" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Immediate Future Drill</h2><p class="text-slate-600 text-base flex-grow">Master the "going to" future (`ir` + infinitive), the most common future form.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c1dabc6b048191a4d4b8d14b022b68-immediate-future-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('immediate-future')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('immediate-future', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-present-continuous" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Present Continuous Tense</h2><p class="text-slate-600 text-base flex-grow">Master the Portuguese "-ing" form (`-ndo`) using `estar` + gerund.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c1e0a7746c8191b148791ce4df4f00-present-continuous-tense-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('present-continuous')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('present-continuous', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-imperfect-tense" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Imperfect Tense Drill</h2><p class="text-slate-600 text-base flex-grow">Practice the simple form ("used to do"), the past continuous ("was doing"), and the past intent ("was going to do").</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c200e16c108191991fabf5d0f5f790-imperfect-tense-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('imperfect-tense')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('imperfect-tense', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-future-tense" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Future Tense Drill</h2><p class="text-slate-600 text-base flex-grow">Master the Portuguese "will" tense (`-ei`, `-Ã¡` endings). Covers regular and key irregular verbs.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c2070450a08191bdf2e55f512949a8-future-tense-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('future-tense')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('future-tense', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-conditional-tense" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Conditional Tense Drill</h2><p class="text-slate-600 text-base flex-grow">Master the Portuguese "would" tense (`-ia` endings). Covers regular and key irregular verbs.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c20fe3ebfc81919b22fb21541b2f7a-conditional-tense-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('conditional-tense')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('conditional-tense', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-present-subjunctive" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Present Subjunctive Drill</h2><p class="text-slate-600 text-base flex-grow">Master the subjunctive after triggers like `Espero que...` and `Quero que...`.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c21658b9d08191b9faf99491dee196-present-subjunctive-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('present-subjunctive')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('present-subjunctive', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-imperfect-subjunctive" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Imperfect Subjunctive Drill</h2><p class="text-slate-600 text-base flex-grow">Master hypothetical "if" clauses (`Se eu fosse...`) for regular and irregular verbs.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c234f932608191a7fe7a1dbca53507-imperfect-subjunctive-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('imperfect-subjunctive')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('imperfect-subjunctive', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-future-subjunctive" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Future Subjunctive Drill</h2><p class="text-slate-600 text-base flex-grow">Master hypothetical future situations using `Quando...` and `Se...`.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c238f1da2881919e42deb77e1395e1-future-subjunctive-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('future-subjunctive')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('future-subjunctive', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-imperative" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Imperative Drill</h2><p class="text-slate-600 text-base flex-grow">Master the Portuguese command form. Tests the formal (`fale`) and provides notes on the spoken form (`fala`).</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c23bb180b481918200c55455f5c14b-imperative-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('imperative')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('imperative', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-noun-plurals" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Noun Plural Tutor</h2><p class="text-slate-600 text-base flex-grow">Master the rules for forming noun plurals, with analogies for Spanish speakers.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68a882666ed08191b9c99f161a0310a8-noun-plural-tutor?model=gpt-5" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('noun-plurals')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('noun-plurals', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-adjective-agreement" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Adjective Gender & Number Agreement</h2><p class="text-slate-600 text-base flex-grow">Practice making adjectives match the gender and number of the nouns they describe.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c23e035618819185c3b3a400b58880-adjective-agreement-drill?model=gpt-5" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('adjective-agreement')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('adjective-agreement', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-demonstratives" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Demonstrative Pronouns Drill</h2><p class="text-slate-600 text-base flex-grow">Master the tricky distinction between `este` (near me), `esse` (near you), and `aquele` (over there).</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c251a602148191becd5a26169c727e-demonstratives-drill?model=gpt-5" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('demonstratives')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('demonstratives', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-ir-transportation" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— 'Ir' + Transportation Drill</h2><p class="text-slate-600 text-base flex-grow">Practice using the verb 'ir' (to go) with different modes of transportation like 'de carro', 'a pÃ©', and 'de Uber'.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c253cd531c819193e9f7a6e862b116-ir-transport-tutor" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('ir-transportation')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('ir-transportation', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-advanced-demonstratives" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Advanced Demonstratives</h2><p class="text-slate-600 text-base flex-grow">Master conversational uses, including discourse proximity and the common 'este' -> 'esse' conflation.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c252ec16648191baf129f287673588-advanced-demonstratives" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('advanced-demonstratives')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('advanced-demonstratives', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-crase" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Crase (`Ã `) Tutor</h2><p class="text-slate-600 text-base flex-grow">A dedicated drill for mastering the crase. Learn when to use `Ã ` and `Ã s` with instant feedback.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c25b6d0b2c8191b164d08f2d8e1353-crase-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('crase')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('crase', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-contractions-de" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Contraction Trainer (`dele`/`dela`)</h2><p class="text-slate-600 text-base flex-grow">Practice possessives (`his book`) and verb objects (`I like him`).</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c30097c5e48191b00d958baf0771a9-dele-dela-deles-delas" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('contractions-de')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('contractions-de', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-contractions-em" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Contraction Trainer (`nele`/`nela`)</h2><p class="text-slate-600 text-base flex-grow">Practice location (`in it`) and verb objects (`I think about him`).</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c30b7ff3a48191b69acb4dd4953656-nele-nela-neles-nelas" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('contractions-em')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('contractions-em', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-contractions-articles" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Contractions with Articles (de/em)</h2><p class="text-slate-600 text-base flex-grow">Learn how "de" and "em" contract with articles using step-by-step fill-in-the-blank drills.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c30c8714b081919c37309e9fdee081-contraction-trainer-de-em" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('contractions-articles')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('contractions-articles', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-syllable-stress" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="pronunciation" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-orange-100 text-orange-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Pronunciation</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”Š Syllable Stress Drill</h2><p class="text-slate-600 text-base flex-grow">Master Portuguese syllable stress for perfect pronunciation. Learn the rules for stress and accent marks.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c31b6ef1fc8191a815504142eeaa46-syllable-stress-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('syllable-stress')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('syllable-stress', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-phonetics-br" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="pronunciation" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-orange-100 text-orange-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Pronunciation</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”Š PT-BR Phonetic Tutor</h2><p class="text-slate-600 text-base flex-grow">Learn how Brazilian Portuguese transforms from written to spoken form. Master palatalization, vowel reduction, and more.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c3ac2c95e881918061de6ae3fab4f4-phonetic-tutor" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('phonetics-br')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('phonetics-br', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-colloquial-speech" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Colloquial Speech Drill</h2><p class="text-slate-600 text-base flex-grow">Rewrite formal sentences the way people actually talk. Master reductions (vocÃªâ†’cÃª, estarâ†’tÃ¡) and mergers (vocÃª estÃ¡â†’cÃª tÃ¡).</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c3c587c6fc8191877d9bdac5456510-colloquial-speech-bp" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('colloquial-speech')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('colloquial-speech', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-conversational-answers" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Conversational Answers Drill</h2><p class="text-slate-600 text-base flex-grow">Answer yes/no questions by repeating the verb (VocÃª fala? â†’ Falo.). Includes BP emphatic forms (Falo, sim!).</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c3af4d8df8819189cc01a871f1d7e0-yes-no-replies" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('conversational-answers')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('conversational-answers', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-self-introduction" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Self-Introduction Drill</h2><p class="text-slate-600 text-base flex-grow">For absolute beginners. Build your first sentences: name, profession, nationality, city, languages, workplace.</p></div><div class="p-6 bg-slate-50">
                        <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c3c1e8b54881918e745a7e8e143fb4-self-introduction-drill" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('self-introduction')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('self-introduction', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-portuguese-for-spanish" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Portuguese for Spanish Speakers</h2><p class="text-slate-600 text-base flex-grow">Leverage your Spanish to learn Portuguese faster. Focus on false friends, vocabulary gaps, pronunciation, and grammar differences.</p></div><div class="p-6 bg-slate-50">
                    <div class="flex gap-2 mb-2">
                            <a href="https://chatgpt.com/g/g-68c3c413d418819190babd76e6a9f9e6-portuguese-for-spanish-speakers" target="_blank" class="flex-1 text-center bg-blue-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-blue-700 transition-colors text-sm">ChatGPT Version</a>
                            <button onclick="openDrillChat('portuguese-for-spanish')" class="flex-1 text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm">ðŸš€ Try Integrated</button>
                        </div>
                        <button onclick="copyDrillLink('portuguese-for-spanish', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-grammar-for-spanish" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Grammar for Spanish Speakers</h2><p class="text-slate-600 text-base flex-grow">A focused drill on the key grammatical differences between Spanish and Portuguese, like contractions and pronoun placement.</p></div><div class="p-6 bg-slate-50"><a href="#" target="_blank" class="block w-full text-center bg-gray-400 text-white rounded-lg px-4 py-2.5 font-semibold cursor-not-allowed" aria-disabled="true">Coming Soon</a></div></div>
                <div id="no-results" class="hidden col-span-1 md:col-span-2 lg:col-span-3 text-center py-16"><h3 class="text-2xl font-semibold text-slate-600">Nenhum resultado</h3><p class="text-slate-500 mt-2">No drills matched your search. Try removing some filters or changing your search term.</p></div>
            </div>
        </main>
    </div>

    <footer class="bg-slate-100 border-t border-slate-200">
        <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 text-center text-slate-500">
            <p>&copy; 2025 Gil Klein. All Rights Reserved.</p>
            <p class="text-sm mt-1">Made with â¤ï¸ in New York City.</p>
        </div>
    </footer>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cefrFilterControls = document.getElementById('cefr-filter-controls');
            const topicFilterControls = document.getElementById('topic-filter-controls');
            const drillCards = document.querySelectorAll('.drill-card');
            const searchInput = document.getElementById('search-input');
            const noResultsMessage = document.getElementById('no-results');
            
            // NEW: Path display logic variables
            const pathTriggers = document.getElementById('path-triggers');
            const pathDisplayContainer = document.getElementById('path-display-container');
            const pathButtons = pathTriggers.querySelectorAll('.path-btn');

            function filterAndSearch() {
                const activeCefrFilter = cefrFilterControls.querySelector('.active').dataset.filter;
                const activeTopicFilter = topicFilterControls.querySelector('.active').dataset.filter;
                const searchTerm = searchInput.value.toLowerCase().trim();
                let visibleCount = 0;

                drillCards.forEach(card => {
                    const cardCefr = card.dataset.cefr;
                    const cardTopic = card.dataset.topic;
                    const cardTitle = card.querySelector('h2').textContent.toLowerCase();
                    const cardDescription = card.querySelector('p').textContent.toLowerCase();

                    const matchesCefr = activeCefrFilter === 'all' || cardCefr === activeCefrFilter;
                    const matchesTopic = activeTopicFilter === 'all' || cardTopic === activeTopicFilter;
                    const matchesSearch = cardTitle.includes(searchTerm) || cardDescription.includes(searchTerm);

                    if (matchesCefr && matchesTopic && matchesSearch) {
                        card.classList.remove('hidden');
                        visibleCount++;
                    } else {
                        card.classList.add('hidden');
                    }
                });

                noResultsMessage.classList.toggle('hidden', visibleCount > 0);
            }

            function setupFilter(controlsId, buttonClass, activeBgColor) {
                const controls = document.getElementById(controlsId);
                const buttons = controls.querySelectorAll(`.${buttonClass}`);
                
                controls.addEventListener('click', (event) => {
                    const targetButton = event.target.closest(`.${buttonClass}`);
                    if (!targetButton) return;

                    buttons.forEach(button => {
                        const isActive = button === targetButton;
                        button.classList.toggle('active', isActive);
                        button.classList.toggle(activeBgColor, isActive);
                        button.classList.toggle('text-white', isActive);
                        button.classList.toggle('bg-white', !isActive);
                        button.classList.toggle('text-slate-700', !isActive);
                        button.setAttribute('aria-pressed', isActive);
                    });
                    
                    filterAndSearch();
                });
            }

            setupFilter('cefr-filter-controls', 'cefr-filter-btn', 'bg-indigo-600');
            setupFilter('topic-filter-controls', 'topic-filter-btn', 'bg-blue-600');

            searchInput.addEventListener('input', filterAndSearch);
            
            // NEW: Learning Path display logic
            pathTriggers.addEventListener('click', (event) => {
                const targetButton = event.target.closest('.path-btn');
                if (!targetButton) return;

                const pathId = targetButton.dataset.pathId;
                const wasActive = targetButton.classList.contains('bg-indigo-600');

                // Reset all path buttons
                pathButtons.forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-white', 'text-slate-700');
                });

                // Clear the display container
                pathDisplayContainer.innerHTML = '';

                // If the button was not active, make it active and show the path
                if (!wasActive) {
                    targetButton.classList.add('bg-indigo-600', 'text-white');
                    targetButton.classList.remove('bg-white', 'text-slate-700');
                    const pathTemplate = document.getElementById(pathId);
                    if (pathTemplate) {
                        pathDisplayContainer.innerHTML = pathTemplate.outerHTML;
                    }
                }
            });

            // Event delegation for path-link clicks
            pathDisplayContainer.addEventListener('click', (event) => {
                const pathLink = event.target.closest('.path-link');
                if (pathLink) {
                    event.preventDefault();
                    const targetId = pathLink.dataset.targetId;
                    const targetCard = document.getElementById(targetId);

                    // Remove highlight from any other card
                    const currentlyHighlighted = document.querySelector('.drill-card.highlight');
                    if (currentlyHighlighted) {
                        currentlyHighlighted.classList.remove('highlight');
                    }

                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetCard.classList.add('highlight');
                    }
                }
            });

            filterAndSearch();

            // Check for drill URL parameters and auto-open chat
            const urlParams = new URLSearchParams(window.location.search);
            const drillParam = urlParams.get('drill');        // Single drill
            const drillsParam = urlParams.get('drills');      // Multiple drills (comma-separated)

            if (drillParam) {
                // Single drill mode
                setTimeout(() => {
                    openDrillChat(drillParam);

                    // Scroll to and highlight the drill card
                    const targetCard = document.getElementById('drill-' + drillParam);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetCard.classList.add('highlight');
                    }
                }, 300);
            } else if (drillsParam) {
                // Multiple drills mode
                const drillIds = drillsParam.split(',').map(id => id.trim()).filter(id => id);

                if (drillIds.length > 0) {
                    setTimeout(async () => {
                        // Open empty session first
                        openEmptySession();

                        // Small delay to let empty session initialize
                        await new Promise(resolve => setTimeout(resolve, 500));

                        // Add each drill to the session sequentially
                        for (const drillId of drillIds) {
                            try {
                                await addDrillToChat(drillId);
                                // Small delay between adding drills
                                await new Promise(resolve => setTimeout(resolve, 300));
                            } catch (error) {
                                console.error(`Failed to add drill ${drillId}:`, error);
                            }
                        }

                        // Scroll to and highlight the first drill card
                        const targetCard = document.getElementById('drill-' + drillIds[0]);
                        if (targetCard) {
                            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            targetCard.classList.add('highlight');
                        }
                    }, 300);
                }
            }
        });
    </script>

    <!-- Chat Modal -->
    <div id="chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-2">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-slate-200">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-green-600 font-bold">PT</span>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div id="chat-drill-title" class="font-semibold text-slate-900 mb-1"></div>
                        <p class="text-sm text-slate-500">Integrated AI Tutor</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="openDrillSelector()" class="text-green-600 hover:text-green-700 p-2 rounded-lg hover:bg-green-50 text-sm font-medium">
                        + Add Drill
                    </button>
                    <button onclick="startNewSession()" class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 text-sm font-medium">
                        New Session
                    </button>
                    <button id="share-chat-btn" onclick="shareChatState(this)" class="text-purple-600 hover:text-purple-700 p-2 rounded-lg hover:bg-purple-50 text-sm font-medium" title="Share this chat session">
                        ðŸ”— Share
                    </button>
                    <button onclick="closeDrillChat()" class="text-slate-400 hover:text-slate-600 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Active Drills Badges -->
            <div id="active-drills-container" class="hidden px-4 pt-3 pb-2 border-b border-slate-200 bg-slate-50">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs font-medium text-slate-600">Active Drills:</span>
                    <div id="active-drills-badges" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-green-600 text-sm font-bold">AI</span>
                    </div>
                    <div class="bg-slate-100 rounded-2xl p-3 max-w-2xl">
                        <div id="loading-message" class="text-slate-600">Starting your drill session...</div>
                    </div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="border-t border-slate-200 p-4">
                <div class="flex space-x-3">
                    <input 
                        type="text" 
                        id="chat-input" 
                        placeholder="Type your answer or message..."
                        class="flex-1 border border-slate-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        disabled
                    >
                    <button 
                        onclick="sendChatMessage()"
                        id="chat-send-btn"
                        class="bg-green-600 text-white rounded-full px-6 py-2 font-semibold hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Drill Selector Modal -->
    <div id="drill-selector-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200">
                <h2 class="text-2xl font-bold text-slate-900">Add Another Drill</h2>
                <button onclick="closeDrillSelector()" class="text-slate-400 hover:text-slate-600 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Drill List -->
            <div id="drill-selector-list" class="p-6 space-y-3">
                <!-- Drills will be populated here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
// Chat functionality
let currentChatSession = null;
let currentDrillId = null;
let activeDrills = []; // Array of drill IDs active in current session
let drillSessions = {}; // Store separate sessions for each drill type

// Function to reset all sessions - for debugging
function resetAllSessions() {
  console.log('Resetting all sessions');
  drillSessions = {};
  currentChatSession = null;
  currentDrillId = null;
  activeDrills = [];
}

// Function to start a new session for the current drill
async function startNewSession() {
  if (!currentDrillId) return;

  console.log('Starting new session for drill:', currentDrillId);
  console.log('Before clearing - drillSessions:', drillSessions);

  // Clear the current drill's session completely
  delete drillSessions[currentDrillId];
  currentChatSession = null;
  activeDrills = []; // Clear active drills array

  console.log('After clearing - drillSessions:', drillSessions);

  // Clear the UI immediately
  const messagesContainer = document.getElementById('chat-messages');
  messagesContainer.innerHTML = '<div class="flex items-start space-x-3"><div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-green-600 text-sm font-bold">AI</span></div><div class="bg-slate-100 rounded-2xl p-3 max-w-2xl"><div id="loading-message" class="text-slate-600">Starting fresh session...</div></div></div>';

  // Start completely new session
  setTimeout(() => {
    openDrillChat(currentDrillId);
  }, 500);
}

// A1 Simplifier Functions
function toggleSimplifier() {
  const content = document.getElementById('simplifier-content');
  const chevron = document.getElementById('simplifier-chevron');

  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    chevron.classList.add('rotate-180');
  } else {
    content.classList.add('hidden');
    chevron.classList.remove('rotate-180');
  }
}

async function simplifyText() {
  const input = document.getElementById('simplifier-input');
  const output = document.getElementById('simplifier-output');
  const simplifyBtn = document.getElementById('simplify-btn');
  const copyBtn = document.getElementById('copy-btn');

  const inputText = input.value.trim();

  if (!inputText) {
    output.innerHTML = '<div class="text-red-600 p-4">Please enter some Portuguese text to simplify.</div>';
    return;
  }

  // Disable button and show loading
  simplifyBtn.disabled = true;
  simplifyBtn.textContent = 'Simplifying...';
  copyBtn.classList.add('hidden');

  output.innerHTML = '<div class="flex items-center justify-center h-full"><div class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"></div><p class="text-slate-600">Simplifying text to A1 level...</p></div></div>';

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 second timeout

    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: null,
        drillId: 'a1-simplifier',
        message: inputText,
        isNewSession: true
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text().catch(() => 'Unknown error');
      throw new Error(`Server error (${response.status}): ${errorText}`);
    }

    const data = await response.json();

    // Display the simplified text
    output.innerHTML = `<div class="prose prose-slate max-w-none whitespace-pre-wrap">${escapeHtml(data.response)}</div>`;

    // Show copy button
    copyBtn.classList.remove('hidden');

  } catch (error) {
    console.error('Error simplifying text:', error);

    let errorMessage = 'Connection error. ';
    if (error.name === 'AbortError') {
      errorMessage = 'Request timed out. ';
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'Network error. Check your connection. ';
    } else if (error.message.includes('Server error')) {
      errorMessage = error.message + ' ';
    }

    output.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4"><p class="text-red-800 text-sm mb-3">${errorMessage}</p><button onclick="simplifyText()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition-colors text-sm">Retry</button></div>`;

  } finally {
    simplifyBtn.disabled = false;
    simplifyBtn.textContent = 'Simplify to A1';
  }
}

function copySimplifiedText() {
  const output = document.getElementById('simplifier-output');
  const textContent = output.textContent.trim();

  if (textContent) {
    navigator.clipboard.writeText(textContent).then(() => {
      const copyBtn = document.getElementById('copy-btn');
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyBtn.textContent = originalText;
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy text:', err);
      alert('Failed to copy text to clipboard');
    });
  }
}

function clearSimplifier() {
  const input = document.getElementById('simplifier-input');
  const output = document.getElementById('simplifier-output');
  const copyBtn = document.getElementById('copy-btn');

  input.value = '';
  copyBtn.classList.add('hidden');

  output.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400"><div class="text-center"><svg class="w-16 h-16 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p class="text-sm">Simplified text will appear here</p></div></div>';
}

// Function to start an empty session with no drills
function startEmptySession() {
  // Create a unique session ID for empty sessions
  const emptySessionId = 'empty-' + Date.now();

  // Reset all session data
  currentChatSession = null;
  currentDrillId = emptySessionId;
  activeDrills = [];

  // Store empty session
  drillSessions[emptySessionId] = {
    sessionId: null,
    drillType: emptySessionId,
    activeDrills: [],
    messages: []
  };

  // Open the chat modal
  const modal = document.getElementById('chat-modal');
  const messagesContainer = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('chat-send-btn');

  // Show modal
  modal.classList.remove('hidden');

  // Update title
  updateChatTitle();

  // Update badges
  updateActiveDrillsBadges();

  // Clear messages and show welcome
  messagesContainer.innerHTML = '';
  const welcomeMessage = document.createElement('div');
  welcomeMessage.className = 'flex justify-center my-8';
  welcomeMessage.innerHTML = `
    <div class="text-center p-6 bg-slate-50 rounded-lg max-w-md">
      <h3 class="text-xl font-semibold text-slate-900 mb-3">Empty Session Started</h3>
      <p class="text-slate-600 mb-4">No drills are currently active. Click the "+ Add Drill" button above to add drills and start practicing.</p>
      <p class="text-sm text-slate-500">You can add multiple drills to practice them together with random alternation.</p>
    </div>
  `;
  messagesContainer.appendChild(welcomeMessage);

  // Disable input until a drill is added
  chatInput.disabled = true;
  sendButton.disabled = true;
  chatInput.placeholder = 'Add a drill to continue...';

  // Add enter key handler
  chatInput.onkeypress = function(e) {
    if (e.key === 'Enter') {
      sendChatMessage();
    }
  };
}

async function openDrillChat(drillId) {
  
  // Detect if we're switching drill types BEFORE updating currentDrillId
  const previousDrillId = currentDrillId;
  const isSwitchingDrillTypes = previousDrillId && previousDrillId !== drillId;
  
  // If switching to different drill type, reset current session
  if (isSwitchingDrillTypes) {
    currentChatSession = null;
  }
  
  const modal = document.getElementById('chat-modal');
  const messagesContainer = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('chat-send-btn');
  const loadingMessage = document.getElementById('loading-message');
  
  // Show modal
  modal.classList.remove('hidden');
  
  // Update current drill and set title
  currentDrillId = drillId;
  const drillTitle = document.getElementById('chat-drill-title');
  
  // Set appropriate title based on drill ID
  switch(drillId) {
    case 'regular-ar':
      drillTitle.textContent = 'Regular -ar Verb Drill';
      break;
    case 'regular-er':
      drillTitle.textContent = 'Regular -er Verb Drill';
      break;
    case 'regular-ir':
      drillTitle.textContent = 'Regular -ir Verb Drill';
      break;
    case 'irregular-verbs':
      drillTitle.textContent = 'Irregular Verbs Drill';
      break;
    case 'ser-estar':
      drillTitle.textContent = 'Ser vs. Estar Drill';
      break;
    case 'ir-transportation':
      drillTitle.textContent = 'Ir + Transportation Drill';
      break;
    case 'contractions-articles':
      drillTitle.textContent = 'Contractions with Articles (de/em)';
      break;
    case 'reflexive-verbs':
      drillTitle.textContent = 'Reflexive Verbs Drill';
      break;
    case 'immediate-future':
      drillTitle.textContent = 'Immediate Future Drill';
      break;
    case 'present-continuous':
      drillTitle.textContent = 'Present Continuous Tense Drill';
      break;
    case 'imperfect-tense':
      drillTitle.textContent = 'Imperfect Tense Drill';
      break;
    case 'future-tense':
      drillTitle.textContent = 'Future Tense Drill';
      break;
    case 'conditional-tense':
      drillTitle.textContent = 'Conditional Tense Drill';
      break;
    case 'present-subjunctive':
      drillTitle.textContent = 'Present Subjunctive Drill';
      break;
    case 'imperfect-subjunctive':
      drillTitle.textContent = 'Imperfect Subjunctive Drill';
      break;
    case 'future-subjunctive':
      drillTitle.textContent = 'Future Subjunctive Drill';
      break;
    case 'imperative':
      drillTitle.textContent = 'Imperative Drill';
      break;
    case 'noun-plurals':
      drillTitle.textContent = 'Noun Plural Tutor';
      break;
    case 'adjective-agreement':
      drillTitle.textContent = 'Adjective Gender & Number Agreement';
      break;
    case 'demonstratives':
      drillTitle.textContent = 'Demonstrative Pronouns Drill';
      break;
    case 'advanced-demonstratives':
      drillTitle.textContent = 'Advanced Demonstratives Drill';
      break;
    case 'crase':
      drillTitle.textContent = 'Crase (Ã ) Tutor';
      break;
    case 'contractions-de':
      drillTitle.textContent = 'Contraction Trainer (dele/dela)';
      break;
    case 'contractions-em':
      drillTitle.textContent = 'Contraction Trainer (nele/nela)';
      break;
    case 'syllable-stress':
      drillTitle.textContent = 'Syllable Stress Drill';
      break;
    case 'phonetics-br':
      drillTitle.textContent = 'Brazilian Portuguese Phonetics Tutor';
      break;
    case 'colloquial-speech':
      drillTitle.textContent = 'Colloquial Speech Drill';
      break;
    case 'conversational-answers':
      drillTitle.textContent = 'Conversational Answers Drill';
      break;
    case 'self-introduction':
      drillTitle.textContent = 'Self-Introduction Drill';
      break;
    case 'portuguese-for-spanish':
      drillTitle.textContent = 'Portuguese for Spanish Speakers';
      break;
    default:
      drillTitle.textContent = 'Portuguese Drill';
  }
  
  console.log('ðŸ”¥ After setting currentDrillId to:', currentDrillId);
  console.log('ðŸ”¥ Looking for existing session with key:', drillId);
  console.log('ðŸ”¥ drillSessions[drillId]:', drillSessions[drillId]);
  console.log('ðŸ”¥ All drillSessions keys:', Object.keys(drillSessions));
  
  // Safety check: If stored session doesn't match drill type, clear it
  if (drillSessions[drillId] && drillSessions[drillId].drillType !== drillId) {
    console.log('ðŸ”¥ WARNING: Session drill type mismatch! Clearing corrupted session.');
    console.log('ðŸ”¥ Expected:', drillId, 'but found:', drillSessions[drillId].drillType);
    delete drillSessions[drillId];
  }
  
  // IMPORTANT: Only restore session if it's for the EXACT same drill type
  // and the stored session actually has the correct drill type
  // AND we're not switching from a different drill type
  console.log('ðŸ”¥ isSwitchingDrillTypes:', isSwitchingDrillTypes);
  
  // Only create fresh session if we're switching to a DIFFERENT drill type
  // If we're returning to the same drill type, restore the session
  const shouldRestoreSession = drillSessions[drillId] && drillSessions[drillId].drillType === drillId;
  console.log('ðŸ”¥ shouldRestoreSession:', shouldRestoreSession);
  
  if (shouldRestoreSession) {
    console.log('ðŸ”¥ Found existing session for:', drillId);
    console.log('ðŸ”¥ Session details:', drillSessions[drillId]);
    console.log('ðŸ”¥ Restoring session...');
    // Restore existing session
    currentChatSession = drillSessions[drillId].sessionId;
    activeDrills = drillSessions[drillId].activeDrills || [drillId]; // Restore activeDrills
    messagesContainer.innerHTML = '';

    // Restore all messages from this session
    drillSessions[drillId].messages.forEach(msg => {
      addMessageToChat(msg.role === 'user' ? 'user' : 'ai', msg.content);
    });

    // Update drill badges display
    updateActiveDrillsBadges();

    // Update the chat title
    updateChatTitle();

    // Enable input
    chatInput.disabled = false;
    sendButton.disabled = false;

    // Add enter key handler
    chatInput.onkeypress = function(e) {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    };

    return;
  } else {
    console.log('ðŸ”¥ No existing session found for:', drillId, 'or switching drill types');
    console.log('ðŸ”¥ Creating new session...');
  }
  
  // Disable input while starting new session
  chatInput.disabled = true;
  sendButton.disabled = true;
  
  // Show loading message
  messagesContainer.innerHTML = '<div class="flex items-start space-x-3"><div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-green-600 text-sm font-bold">AI</span></div><div class="bg-slate-100 rounded-2xl p-3 max-w-2xl"><div id="loading-message" class="text-slate-600">Starting your drill session...</div></div></div>';
  
  console.log('ðŸ”¥ Set loading message and disabled input');
  
  try {
    // Start new chat session with timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
    
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        drillId: drillId,
        isNewSession: true
      }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    currentChatSession = data.sessionId;

    // Initialize activeDrills array with the first drill
    activeDrills = [drillId];

    // Store new session data
    drillSessions[drillId] = {
      sessionId: data.sessionId,
      drillType: drillId, // Explicitly store the drill type
      activeDrills: [drillId], // Track active drills
      messages: [{ role: 'assistant', content: data.response }]
    };

    console.log('ðŸ”¥ Created new session for drillId:', drillId);
    console.log('ðŸ”¥ Session data:', drillSessions[drillId]);
    console.log('ðŸ”¥ All sessions now:', JSON.stringify(drillSessions, null, 2));
    
    // Clear loading and show AI response
    messagesContainer.innerHTML = '';
    addMessageToChat('ai', data.response);

    // Update drill badges display
    updateActiveDrillsBadges();

    // Update the chat title
    updateChatTitle();

    // Enable input
    chatInput.disabled = false;
    sendButton.disabled = false;

    // Add enter key handler
    chatInput.onkeypress = function(e) {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    };
    
  } catch (error) {
    console.error('Error starting chat session:', error);
    loadingMessage.textContent = 'Sorry, there was an error starting the session. Please try again later.';
  }
}

async function sendChatMessage(retryMessage = null) {
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('chat-send-btn');
  const message = retryMessage || chatInput.value.trim();

  if (!message || !currentChatSession) return;

  let userMessageDiv = null;

  // Only add user message if this is not a retry
  if (!retryMessage) {
    userMessageDiv = addMessageToChat('user', message);

    // Store user message in session history
    if (currentDrillId && drillSessions[currentDrillId]) {
      drillSessions[currentDrillId].messages.push({ role: 'user', content: message });
    }

    // Clear input and disable while processing
    chatInput.value = '';
  }

  chatInput.disabled = true;
  sendButton.disabled = true;

  // Show typing indicator
  const typingIndicator = addMessageToChat('ai', '...');

  try {
    // Randomly select a drill from activeDrills array
    const selectedDrill = activeDrills.length > 0
      ? activeDrills[Math.floor(Math.random() * activeDrills.length)]
      : currentDrillId;

    console.log('ðŸŽ² Randomly selected drill:', selectedDrill, 'from', activeDrills);

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 second timeout for mobile

    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        sessionId: currentChatSession,
        drillId: selectedDrill,
        message: message
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text().catch(() => 'Unknown error');
      throw new Error(`Server error (${response.status}): ${errorText}`);
    }

    const data = await response.json();

    // Remove typing indicator and add real response
    typingIndicator.remove();
    addMessageToChat('ai', data.response);

    // Store AI response in session history
    if (currentDrillId && drillSessions[currentDrillId]) {
      drillSessions[currentDrillId].messages.push({ role: 'assistant', content: data.response });
    }

  } catch (error) {
    console.error('Error sending message:', error);

    // Remove typing indicator
    typingIndicator.remove();

    // Determine error type
    let errorMessage = 'Connection error. ';
    if (error.name === 'AbortError') {
      errorMessage = 'Request timed out. ';
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'Network error. Check your connection. ';
    } else if (error.message.includes('Server error')) {
      errorMessage = error.message + ' ';
    }

    // Show error with retry button
    const errorDiv = document.createElement('div');
    errorDiv.className = 'flex justify-center my-4';
    errorDiv.innerHTML = `
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 max-w-md">
        <p class="text-red-800 text-sm mb-3">${errorMessage}</p>
        <button
          onclick="retrySendMessage('${escapeForJs(message)}')"
          class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition-colors text-sm"
        >
          Retry Message
        </button>
      </div>
    `;

    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.appendChild(errorDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

  } finally {
    // Re-enable input
    chatInput.disabled = false;
    sendButton.disabled = false;
  }
}

// Helper function to escape strings for JavaScript
function escapeForJs(str) {
  return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
}

// Retry function
function retrySendMessage(message) {
  sendChatMessage(message);
}

// Conjugation button helpers for all verb drills
function shouldShowConjugationButtons(content) {
  // List of verb drills that support conjugation buttons
  const verbDrills = ['regular-ar', 'regular-er', 'regular-ir', 'irregular-verbs'];

  // Check if any verb drill is active
  const hasVerbDrill = verbDrills.some(drill => activeDrills.includes(drill));
  if (!hasVerbDrill) {
    return false;
  }

  // Check if message contains a blank and a verb in parentheses
  return content.includes('______') && /\(([a-zÃ¡Ã Ã¢Ã£Ã©ÃªÃ­Ã³Ã´ÃµÃºÃ§]+(?:ar|er|ir))\)/i.test(content);
}

function extractVerbFromMessage(content) {
  // Extract verb from pattern: ______ (falar/comer/abrir)
  const match = content.match(/\(([a-zÃ¡Ã Ã¢Ã£Ã©ÃªÃ­Ã³Ã´ÃµÃºÃ§]+(?:ar|er|ir))\)/i);
  return match ? match[1].toLowerCase() : null;
}

function getVerbType(infinitive) {
  if (infinitive.endsWith('ar')) return 'ar';
  if (infinitive.endsWith('er')) return 'er';
  if (infinitive.endsWith('ir')) return 'ir';
  return null;
}

function conjugateArVerb(infinitive, tense) {
  // Get the stem by removing -ar
  const stem = infinitive.slice(0, -2);

  if (tense === 'present') {
    return {
      'eu': stem + 'o',
      'ele/ela/vocÃª': stem + 'a',
      'a gente': stem + 'a',
      'nÃ³s': stem + 'amos',
      'eles/elas/vocÃªs': stem + 'am'
    };
  } else if (tense === 'past') {
    // Handle orthographic changes for -car, -gar, -Ã§ar verbs
    let euStem = stem;
    if (stem.endsWith('c')) {
      euStem = stem.slice(0, -1) + 'qu';
    } else if (stem.endsWith('g')) {
      euStem = stem.slice(0, -1) + 'gu';
    } else if (stem.endsWith('Ã§')) {
      euStem = stem.slice(0, -1) + 'c';
    }

    return {
      'eu': euStem + 'ei',
      'ele/ela/vocÃª': stem + 'ou',
      'a gente': stem + 'ou',
      'nÃ³s': stem + 'amos',
      'eles/elas/vocÃªs': stem + 'aram'
    };
  }
}

function conjugateErVerb(infinitive, tense) {
  // Get the stem by removing -er
  const stem = infinitive.slice(0, -2);

  if (tense === 'present') {
    return {
      'eu': stem + 'o',
      'ele/ela/vocÃª': stem + 'e',
      'a gente': stem + 'e',
      'nÃ³s': stem + 'emos',
      'eles/elas/vocÃªs': stem + 'em'
    };
  } else if (tense === 'past') {
    return {
      'eu': stem + 'i',
      'ele/ela/vocÃª': stem + 'eu',
      'a gente': stem + 'eu',
      'nÃ³s': stem + 'emos',
      'eles/elas/vocÃªs': stem + 'eram'
    };
  }
}

function conjugateIrVerb(infinitive, tense) {
  // Get the stem by removing -ir
  const stem = infinitive.slice(0, -2);

  if (tense === 'present') {
    return {
      'eu': stem + 'o',
      'ele/ela/vocÃª': stem + 'e',
      'a gente': stem + 'e',
      'nÃ³s': stem + 'imos',
      'eles/elas/vocÃªs': stem + 'em'
    };
  } else if (tense === 'past') {
    return {
      'eu': stem + 'i',
      'ele/ela/vocÃª': stem + 'iu',
      'a gente': stem + 'iu',
      'nÃ³s': stem + 'imos',
      'eles/elas/vocÃªs': stem + 'iram'
    };
  }
}

// Irregular verb conjugations
const irregularVerbs = {
  'ser': {
    present: { 'eu': 'sou', 'ele/ela/vocÃª': 'Ã©', 'a gente': 'Ã©', 'nÃ³s': 'somos', 'eles/elas/vocÃªs': 'sÃ£o' },
    past: { 'eu': 'fui', 'ele/ela/vocÃª': 'foi', 'a gente': 'foi', 'nÃ³s': 'fomos', 'eles/elas/vocÃªs': 'foram' }
  },
  'estar': {
    present: { 'eu': 'estou', 'ele/ela/vocÃª': 'estÃ¡', 'a gente': 'estÃ¡', 'nÃ³s': 'estamos', 'eles/elas/vocÃªs': 'estÃ£o' },
    past: { 'eu': 'estive', 'ele/ela/vocÃª': 'esteve', 'a gente': 'esteve', 'nÃ³s': 'estivemos', 'eles/elas/vocÃªs': 'estiveram' }
  },
  'ir': {
    present: { 'eu': 'vou', 'ele/ela/vocÃª': 'vai', 'a gente': 'vai', 'nÃ³s': 'vamos', 'eles/elas/vocÃªs': 'vÃ£o' },
    past: { 'eu': 'fui', 'ele/ela/vocÃª': 'foi', 'a gente': 'foi', 'nÃ³s': 'fomos', 'eles/elas/vocÃªs': 'foram' }
  },
  'ter': {
    present: { 'eu': 'tenho', 'ele/ela/vocÃª': 'tem', 'a gente': 'tem', 'nÃ³s': 'temos', 'eles/elas/vocÃªs': 'tÃªm' },
    past: { 'eu': 'tive', 'ele/ela/vocÃª': 'teve', 'a gente': 'teve', 'nÃ³s': 'tivemos', 'eles/elas/vocÃªs': 'tiveram' }
  },
  'fazer': {
    present: { 'eu': 'faÃ§o', 'ele/ela/vocÃª': 'faz', 'a gente': 'faz', 'nÃ³s': 'fazemos', 'eles/elas/vocÃªs': 'fazem' },
    past: { 'eu': 'fiz', 'ele/ela/vocÃª': 'fez', 'a gente': 'fez', 'nÃ³s': 'fizemos', 'eles/elas/vocÃªs': 'fizeram' }
  },
  'dizer': {
    present: { 'eu': 'digo', 'ele/ela/vocÃª': 'diz', 'a gente': 'diz', 'nÃ³s': 'dizemos', 'eles/elas/vocÃªs': 'dizem' },
    past: { 'eu': 'disse', 'ele/ela/vocÃª': 'disse', 'a gente': 'disse', 'nÃ³s': 'dissemos', 'eles/elas/vocÃªs': 'disseram' }
  },
  'poder': {
    present: { 'eu': 'posso', 'ele/ela/vocÃª': 'pode', 'a gente': 'pode', 'nÃ³s': 'podemos', 'eles/elas/vocÃªs': 'podem' },
    past: { 'eu': 'pude', 'ele/ela/vocÃª': 'pÃ´de', 'a gente': 'pÃ´de', 'nÃ³s': 'pudemos', 'eles/elas/vocÃªs': 'puderam' }
  },
  'pÃ´r': {
    present: { 'eu': 'ponho', 'ele/ela/vocÃª': 'pÃµe', 'a gente': 'pÃµe', 'nÃ³s': 'pomos', 'eles/elas/vocÃªs': 'pÃµem' },
    past: { 'eu': 'pus', 'ele/ela/vocÃª': 'pÃ´s', 'a gente': 'pÃ´s', 'nÃ³s': 'pusemos', 'eles/elas/vocÃªs': 'puseram' }
  },
  'querer': {
    present: { 'eu': 'quero', 'ele/ela/vocÃª': 'quer', 'a gente': 'quer', 'nÃ³s': 'queremos', 'eles/elas/vocÃªs': 'querem' },
    past: { 'eu': 'quis', 'ele/ela/vocÃª': 'quis', 'a gente': 'quis', 'nÃ³s': 'quisemos', 'eles/elas/vocÃªs': 'quiseram' }
  },
  'saber': {
    present: { 'eu': 'sei', 'ele/ela/vocÃª': 'sabe', 'a gente': 'sabe', 'nÃ³s': 'sabemos', 'eles/elas/vocÃªs': 'sabem' },
    past: { 'eu': 'soube', 'ele/ela/vocÃª': 'soube', 'a gente': 'soube', 'nÃ³s': 'soubemos', 'eles/elas/vocÃªs': 'souberam' }
  },
  'ver': {
    present: { 'eu': 'vejo', 'ele/ela/vocÃª': 'vÃª', 'a gente': 'vÃª', 'nÃ³s': 'vemos', 'eles/elas/vocÃªs': 'veem' },
    past: { 'eu': 'vi', 'ele/ela/vocÃª': 'viu', 'a gente': 'viu', 'nÃ³s': 'vimos', 'eles/elas/vocÃªs': 'viram' }
  },
  'dar': {
    present: { 'eu': 'dou', 'ele/ela/vocÃª': 'dÃ¡', 'a gente': 'dÃ¡', 'nÃ³s': 'damos', 'eles/elas/vocÃªs': 'dÃ£o' },
    past: { 'eu': 'dei', 'ele/ela/vocÃª': 'deu', 'a gente': 'deu', 'nÃ³s': 'demos', 'eles/elas/vocÃªs': 'deram' }
  },
  'trazer': {
    present: { 'eu': 'trago', 'ele/ela/vocÃª': 'traz', 'a gente': 'traz', 'nÃ³s': 'trazemos', 'eles/elas/vocÃªs': 'trazem' },
    past: { 'eu': 'trouxe', 'ele/ela/vocÃª': 'trouxe', 'a gente': 'trouxe', 'nÃ³s': 'trouxemos', 'eles/elas/vocÃªs': 'trouxeram' }
  },
  'vir': {
    present: { 'eu': 'venho', 'ele/ela/vocÃª': 'vem', 'a gente': 'vem', 'nÃ³s': 'vimos', 'eles/elas/vocÃªs': 'vÃªm' },
    past: { 'eu': 'vim', 'ele/ela/vocÃª': 'veio', 'a gente': 'veio', 'nÃ³s': 'viemos', 'eles/elas/vocÃªs': 'vieram' }
  }
};

function getAllConjugations(infinitive) {
  let present, past;

  // Check if it's an irregular verb first
  if (irregularVerbs[infinitive]) {
    present = irregularVerbs[infinitive].present;
    past = irregularVerbs[infinitive].past;
  } else {
    // Regular verb - determine type and conjugate
    const verbType = getVerbType(infinitive);

    if (verbType === 'ar') {
      present = conjugateArVerb(infinitive, 'present');
      past = conjugateArVerb(infinitive, 'past');
    } else if (verbType === 'er') {
      present = conjugateErVerb(infinitive, 'present');
      past = conjugateErVerb(infinitive, 'past');
    } else if (verbType === 'ir') {
      present = conjugateIrVerb(infinitive, 'present');
      past = conjugateIrVerb(infinitive, 'past');
    } else {
      return [];
    }
  }

  // Combine all unique forms
  const allForms = new Set();
  if (present) Object.values(present).forEach(form => allForms.add(form));
  if (past) Object.values(past).forEach(form => allForms.add(form));

  return Array.from(allForms);
}

function shuffleArray(array) {
  // Fisher-Yates shuffle
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

function addConjugationButtons(messagesContainer, content) {
  const verb = extractVerbFromMessage(content);
  if (!verb) return;

  const conjugations = getAllConjugations(verb);
  const shuffled = shuffleArray(conjugations);

  // Create button container
  const buttonContainer = document.createElement('div');
  buttonContainer.className = 'flex items-start space-x-3 mb-4';
  buttonContainer.innerHTML = `
    <div class="w-8 h-8 flex-shrink-0"></div>
    <div class="flex flex-wrap gap-2 max-w-2xl">
      ${shuffled.map(conj => `
        <button
          onclick="sendConjugation('${conj.replace(/'/g, "\\'")}')"
          class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium px-4 py-2 rounded-full text-sm transition-colors"
        >
          ${escapeHtml(conj)}
        </button>
      `).join('')}
    </div>
  `;

  messagesContainer.appendChild(buttonContainer);
}

function sendConjugation(conjugation) {
  const chatInput = document.getElementById('chat-input');
  chatInput.value = conjugation;
  sendChatMessage();
}

function addMessageToChat(sender, content) {
  const messagesContainer = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'flex items-start space-x-3';

  if (sender === 'user') {
    messageDiv.className += ' justify-end';
    messageDiv.innerHTML = `
      <div class="bg-green-600 text-white rounded-2xl p-3 max-w-2xl">
        <div class="message-content">${escapeHtml(content)}</div>
      </div>
      <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
        <span class="text-blue-600 text-sm font-bold">You</span>
      </div>
    `;
  } else {
    messageDiv.innerHTML = `
      <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
        <span class="text-green-600 text-sm font-bold">AI</span>
      </div>
      <div class="bg-slate-100 rounded-2xl p-3 max-w-2xl">
        <div class="message-content">${formatAIMessage(content)}</div>
      </div>
    `;
  }

  messagesContainer.appendChild(messageDiv);

  // Add conjugation buttons if this is a question in regular-ar drill
  if (sender === 'ai' && shouldShowConjugationButtons(content)) {
    addConjugationButtons(messagesContainer, content);
  }

  messagesContainer.scrollTop = messagesContainer.scrollHeight;

  return messageDiv;
}

function formatAIMessage(content) {
  // Convert line breaks to <br> and preserve formatting
  return escapeHtml(content)
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
    .replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italic text
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function closeDrillChat() {
  const modal = document.getElementById('chat-modal');
  modal.classList.add('hidden');
  currentChatSession = null;
}

// Copy shareable link for a specific drill
async function copyDrillLink(drillId, buttonElement) {
  const baseUrl = window.location.origin + window.location.pathname;
  const shareableUrl = `${baseUrl}?drill=${drillId}`;

  try {
    await navigator.clipboard.writeText(shareableUrl);

    // Visual feedback
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = 'âœ“ Copied!';
    buttonElement.classList.add('bg-purple-600');
    buttonElement.classList.remove('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');

    // Reset after 2 seconds
    setTimeout(() => {
      buttonElement.innerHTML = originalText;
      buttonElement.classList.remove('bg-purple-600');
      buttonElement.classList.add('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
    }, 2000);
  } catch (err) {
    console.error('Failed to copy link:', err);
    // Fallback: show the URL in an alert
    alert(`Copy this link:\n${shareableUrl}`);
  }
}

// Share current chat state with all active drills
async function shareChatState(buttonElement) {
  const baseUrl = window.location.origin + window.location.pathname;

  // Get all active drills from the current session
  if (!activeDrills || activeDrills.length === 0) {
    alert('No active drills to share. Please add a drill first.');
    return;
  }

  // Create URL with comma-separated drill IDs
  const drillsParam = activeDrills.join(',');
  const shareableUrl = `${baseUrl}?drills=${drillsParam}`;

  try {
    await navigator.clipboard.writeText(shareableUrl);

    // Visual feedback
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = 'âœ“ Copied!';
    buttonElement.classList.add('bg-purple-800', 'text-white');
    buttonElement.classList.remove('text-purple-600', 'hover:text-purple-700');

    // Reset after 2 seconds
    setTimeout(() => {
      buttonElement.innerHTML = originalText;
      buttonElement.classList.remove('bg-purple-800', 'text-white');
      buttonElement.classList.add('text-purple-600', 'hover:text-purple-700');
    }, 2000);
  } catch (err) {
    console.error('Failed to copy chat link:', err);
    // Fallback: show the URL in an alert
    alert(`Copy this link:\n${shareableUrl}`);
  }
}

// Drill selector functions
function openDrillSelector() {
  const modal = document.getElementById('drill-selector-modal');
  const listContainer = document.getElementById('drill-selector-list');

  // Get all drill cards that have integrated chat support
  const drillCards = document.querySelectorAll('.drill-card');
  const drillsWithIntegration = [];

  drillCards.forEach(card => {
    const integratedButton = card.querySelector('button[onclick^="openDrillChat"]');
    if (integratedButton) {
      const drillId = card.id.replace('drill-', '');
      const titleElement = card.querySelector('h2');
      const descriptionElement = card.querySelector('p.text-slate-600');
      const categoryElement = card.querySelector('span.inline-block');

      if (titleElement && !activeDrills.includes(drillId)) {
        drillsWithIntegration.push({
          id: drillId,
          title: titleElement.textContent.trim(),
          description: descriptionElement ? descriptionElement.textContent.trim() : '',
          category: categoryElement ? categoryElement.textContent.trim() : ''
        });
      }
    }
  });

  // Build the drill list HTML
  if (drillsWithIntegration.length === 0) {
    listContainer.innerHTML = '<p class="text-slate-500 text-center py-8">No other drills available to add.</p>';
  } else {
    listContainer.innerHTML = drillsWithIntegration.map(drill => `
      <button onclick="addDrillToChat('${drill.id}')" class="w-full text-left p-4 rounded-lg border border-slate-200 hover:border-green-500 hover:bg-green-50 transition-all">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h3 class="font-semibold text-slate-900 mb-1">${escapeHtml(drill.title)}</h3>
            ${drill.category ? `<span class="inline-block text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 mb-2">${escapeHtml(drill.category)}</span>` : ''}
            <p class="text-sm text-slate-600">${escapeHtml(drill.description)}</p>
          </div>
          <svg class="w-5 h-5 text-green-600 flex-shrink-0 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
        </div>
      </button>
    `).join('');
  }

  modal.classList.remove('hidden');
}

function closeDrillSelector() {
  const modal = document.getElementById('drill-selector-modal');
  modal.classList.add('hidden');
}

async function addDrillToChat(drillId) {
  // Check if drill is already active
  if (activeDrills.includes(drillId)) {
    alert('This drill is already active in the current session.');
    closeDrillSelector();
    return;
  }

  closeDrillSelector();

  const messagesContainer = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('chat-send-btn');

  // Disable input while adding drill
  chatInput.disabled = true;
  sendButton.disabled = true;

  // Add a system message
  const systemMessage = document.createElement('div');
  systemMessage.className = 'flex justify-center my-2';
  systemMessage.innerHTML = `
    <div class="bg-blue-100 text-blue-800 text-sm px-4 py-2 rounded-full">
      Adding drill to session...
    </div>
  `;
  messagesContainer.appendChild(systemMessage);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;

  try {
    // If this is an empty session (no currentChatSession), start a new session with this drill
    if (!currentChatSession) {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          drillId: drillId,
          isNewSession: true
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      currentChatSession = data.sessionId;

      // Add the drill to activeDrills array
      activeDrills.push(drillId);

      // Update the session's active drills
      if (drillSessions[currentDrillId]) {
        drillSessions[currentDrillId].sessionId = data.sessionId;
        drillSessions[currentDrillId].activeDrills = [...activeDrills];
        drillSessions[currentDrillId].messages.push(
          { role: 'assistant', content: data.response }
        );
      }

      // Update the badges display
      updateActiveDrillsBadges();

      // Update the chat title
      updateChatTitle();

      // Remove system message and add AI response
      systemMessage.remove();
      addMessageToChat('ai', data.response);

      // Enable input and restore placeholder
      chatInput.disabled = false;
      sendButton.disabled = false;
      chatInput.placeholder = 'Type your answer...';
  
      return;
    }

    // Send a message to add the drill to existing session
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: currentChatSession,
        message: `[SYSTEM: User wants to add the "${drillId}" drill to this conversation. From now on, alternate between the active drills. Acknowledge this briefly and provide the first exercise for this new drill.]`,
        drillType: drillId
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();

    // Add the drill to activeDrills array
    activeDrills.push(drillId);

    // Update the session's active drills
    if (drillSessions[currentDrillId]) {
      drillSessions[currentDrillId].activeDrills = [...activeDrills];
      drillSessions[currentDrillId].messages.push(
        { role: 'user', content: `[Added drill: ${drillId}]` },
        { role: 'assistant', content: data.response }
      );
    }

    // Update the badges display
    updateActiveDrillsBadges();

    // Update the chat title
    updateChatTitle();

    // Remove system message and add AI response
    systemMessage.remove();
    addMessageToChat('ai', data.response);

    // Enable input and restore placeholder
    chatInput.disabled = false;
    sendButton.disabled = false;
    chatInput.placeholder = 'Type your answer...';

  } catch (error) {
    console.error('Error adding drill:', error);
    systemMessage.innerHTML = `
      <div class="bg-red-100 text-red-800 text-sm px-4 py-2 rounded-full">
        Failed to add drill. Please try again.
      </div>
    `;
    chatInput.disabled = false;
    sendButton.disabled = false;
  }
}

async function removeDrillFromChat(drillId) {
  if (!currentChatSession) {
    return;
  }

  // Remove drill from activeDrills array
  const index = activeDrills.indexOf(drillId);
  if (index === -1) {
    return; // Drill not found
  }

  activeDrills.splice(index, 1);

  // Update the session's active drills
  if (drillSessions[currentDrillId]) {
    drillSessions[currentDrillId].activeDrills = [...activeDrills];
  }

  // Update the badges display
  updateActiveDrillsBadges();

  // Update the chat title
  updateChatTitle();

  // Add a system message to the chat
  const messagesContainer = document.getElementById('chat-messages');
  const systemMessage = document.createElement('div');
  systemMessage.className = 'flex justify-center my-2';
  systemMessage.innerHTML = `
    <div class="bg-slate-100 text-slate-600 text-xs px-3 py-1.5 rounded-full">
      Removed "${getDrillName(drillId)}" from active drills
    </div>
  `;
  messagesContainer.appendChild(systemMessage);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;

  // If no drills remain, disable input and show message
  if (activeDrills.length === 0) {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('chat-send-btn');
    chatInput.disabled = true;
    sendButton.disabled = true;
    chatInput.placeholder = 'Add a drill to continue...';

    // Add empty state message
    const emptyMessage = document.createElement('div');
    emptyMessage.className = 'flex justify-center my-4';
    emptyMessage.innerHTML = `
      <div class="text-center p-4 bg-slate-50 rounded-lg max-w-md">
        <p class="text-slate-600 mb-2">All drills have been removed.</p>
        <p class="text-sm text-slate-500">Click the "+ Add Drill" button to add drills and continue practicing.</p>
      </div>
    `;
    messagesContainer.appendChild(emptyMessage);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

function updateActiveDrillsBadges() {
  const container = document.getElementById('active-drills-container');
  const badgesContainer = document.getElementById('active-drills-badges');

  if (activeDrills.length === 0) {
    // Show empty state message
    container.classList.remove('hidden');
    badgesContainer.innerHTML = `
      <span class="text-xs text-slate-500 italic">No drills loaded. Click "+ Add Drill" to start practicing.</span>
    `;
    return;
  }

  // Show container and populate badges with remove buttons
  container.classList.remove('hidden');
  badgesContainer.innerHTML = activeDrills.map(drillId => {
    const drillName = getDrillName(drillId);
    return `
      <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
        ${escapeHtml(drillName)}
        <button
          onclick="removeDrillFromChat('${drillId}')"
          class="hover:bg-green-200 rounded-full p-0.5 transition-colors"
          title="Remove this drill"
        >
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </span>
    `;
  }).join('');
}

function getDrillName(drillId) {
  const names = {
    'ar-verbs': 'Regular -ar Verbs',
    'er-verbs': 'Regular -er Verbs',
    'ir-verbs': 'Regular -ir Verbs',
    'irregular-verbs': 'Irregular Verbs',
    'ser-estar': 'Ser vs. Estar',
    'reflexive-verbs': 'Reflexive Verbs',
    'immediate-future': 'Immediate Future',
    'present-continuous': 'Present Continuous',
    'imperfect-tense': 'Imperfect Tense',
    'future-tense': 'Future Tense',
    'conditional-tense': 'Conditional Tense',
    'present-subjunctive': 'Present Subjunctive',
    'imperfect-subjunctive': 'Imperfect Subjunctive',
    'future-subjunctive': 'Future Subjunctive',
    'imperative': 'Imperative',
    'noun-plurals': 'Noun Plurals',
    'adjective-agreement': 'Adjective Agreement',
    'demonstratives': 'Demonstratives',
    'ir-transportation': 'Ir + Transportation',
    'advanced-demonstratives': 'Advanced Demonstratives',
    'crase': 'Crase (Ã )',
    'contractions-de': 'Contractions (de)',
    'contractions-em': 'Contractions (em)',
    'contractions-articles': 'Contractions with Articles',
    'syllable-stress': 'Syllable Stress',
    'phonetics-br': 'Phonetics',
    'colloquial-speech': 'Colloquial Speech',
    'conversational-answers': 'Conversational Answers',
    'self-introduction': 'Self-Introduction',
    'portuguese-for-spanish': 'PT for Spanish'
  };
  return names[drillId] || drillId;
}

function updateChatTitle() {
  const drillTitleContainer = document.getElementById('chat-drill-title');

  if (activeDrills.length === 0) {
    drillTitleContainer.textContent = 'No drills active';
    return;
  }

  if (activeDrills.length === 1) {
    drillTitleContainer.textContent = getDrillName(activeDrills[0]);
    return;
  }

  // Multiple drills - show as a list
  const drillNames = activeDrills.map(id => getDrillName(id));
  drillTitleContainer.textContent = drillNames.join(' â€¢ ');
}
    </script>
</body>
</html>
