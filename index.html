<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portuguese Language Tutor</title>
<!-- PWA Manifest -->    <link rel="manifest" href="/manifest.json">    <!-- Theme color for mobile browsers -->    <meta name="theme-color" content="#0ea5e9">    <meta name="apple-mobile-web-app-capable" content="yes">    <meta name="apple-mobile-web-app-status-bar-style" content="default">    <meta name="apple-mobile-web-app-title" content="PT Drills">    <!-- Icons for various devices -->    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">    <link rel="apple-touch-icon" href="/icons/icon-192.png">    <!-- Description for PWA -->    <meta name="description" content="Complete Brazilian Portuguese curriculum (A1-B2) with 90 structured units, AI-powered practice, and pronunciation tools">
    <!-- Force deployment update -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12 sm:py-16 flex-grow">
        
        <header class="text-center mb-12">
            <div class="py-10 px-4 bg-gradient-to-br from-white to-slate-100 rounded-3xl shadow-sm">
                <h1 class="text-4xl sm:text-5xl font-bold tracking-tight text-slate-900">Portuguese Language Tutor</h1>
                <p class="mt-4 max-w-3xl mx-auto text-lg text-slate-600">
                    Complete Brazilian Portuguese curriculum â€¢ A1 to B2 â€¢ 90 structured units
                </p>
                <!-- Big Curriculum Button -->                <div class="mb-6">                    <a href="/syllabus.html" class="inline-flex items-center gap-3 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white font-bold px-8 py-4 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-lg">                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>                        </svg>                        Browse Complete Curriculum (90 Units)                    </a>                </div>                <div class="text-sm text-slate-500 mb-6">Or choose a quick action:</div>
                <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center items-center">
                    <button onclick="startEmptySession()" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg">
                        Start Empty Session
                    </button>
                    <button onclick="showLearningPaths()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                        </svg>
                        Learning Paths
                    </button>
                </div>
            </div>
        </header>

        <!-- Placement Test Section -->
        <section class="mb-12">
            <div class="bg-gradient-to-br from-amber-50 to-yellow-50 rounded-3xl shadow-xl p-8 border-2 border-amber-200">
                <div class="flex items-start gap-4">
                    <div class="w-16 h-16 bg-amber-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h2 class="text-3xl font-bold text-slate-900">Diagnostic Tests</h2>
                            <span class="bg-amber-200 text-amber-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Updated!</span>
                        </div>
                        <p class="text-slate-700 text-base mb-4">
                            Comprehensive diagnostic tests to assess your Portuguese level. Choose by skill or CEFR level.
                        </p>

                        <div class="mb-4">
                            <h3 class="text-sm font-semibold text-slate-600 mb-2">GRAMMAR TESTS</h3>
                            <div class="flex flex-wrap items-center gap-3">
                                <button
                                    onclick="window.location.href='/placement-test?test=grammar-a'"
                                    class="bg-green-500 hover:bg-green-600 text-white font-semibold px-5 py-2.5 rounded-lg transition-colors shadow-md hover:shadow-lg text-sm"
                                >
                                    A-Levels (102 qs)
                                </button>
                                <button
                                    onclick="window.location.href='/placement-test?test=grammar-b'"
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2.5 rounded-lg transition-colors shadow-md hover:shadow-lg text-sm"
                                >
                                    B-Levels (178 qs)
                                </button>
                                <button
                                    onclick="window.location.href='/placement-test?test=grammar'"
                                    class="bg-green-700 hover:bg-green-800 text-white font-semibold px-5 py-2.5 rounded-lg transition-colors shadow-md hover:shadow-lg text-sm"
                                >
                                    Full Test (280 qs)
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h3 class="text-sm font-semibold text-slate-600 mb-2">VOCABULARY TEST</h3>
                            <div class="flex flex-wrap items-center gap-3">
                                <button
                                    onclick="window.location.href='/placement-test?test=vocabulary'"
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2.5 rounded-lg transition-colors shadow-md hover:shadow-lg text-sm"
                                >
                                    Vocabulary (111 qs)
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs mt-4 pt-4 border-t border-amber-200">
                            <div class="flex items-start gap-2 text-slate-600">
                                <span class="w-2 h-2 bg-green-400 rounded-full mt-1 flex-shrink-0"></span>
                                <span><strong>A-Levels:</strong> A1-A2 basics</span>
                            </div>
                            <div class="flex items-start gap-2 text-slate-600">
                                <span class="w-2 h-2 bg-green-600 rounded-full mt-1 flex-shrink-0"></span>
                                <span><strong>B-Levels:</strong> B1-B2 intermediate</span>
                            </div>
                            <div class="flex items-start gap-2 text-slate-600">
                                <span class="w-2 h-2 bg-blue-500 rounded-full mt-1 flex-shrink-0"></span>
                                <span><strong>Vocabulary:</strong> A1-B1 words</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Text Simplifier Section (A1 & A2) -->
        <section class="mb-12">
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-3xl shadow-lg p-6 sm:p-8">
                <button
                    onclick="toggleSimplifier()"
                    class="w-full flex items-center justify-between text-left focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"
                >
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Text Simplifier</h2>
                            <p class="text-slate-600 text-sm mt-1">Convert any text to beginner-level Portuguese (A1/A2)</p>
                        </div>
                    </div>
                    <svg id="simplifier-chevron" class="w-6 h-6 text-slate-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div id="simplifier-content" class="hidden mt-6">
                    <!-- Level Selector -->
                    <div class="mb-6 bg-white rounded-lg p-4 border border-slate-200">
                        <label class="block text-sm font-semibold text-slate-700 mb-3">Select Simplification Level:</label>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <label class="flex items-center cursor-pointer bg-slate-50 hover:bg-slate-100 rounded-lg p-3 border-2 border-transparent has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition-all flex-1 relative">
                                <input
                                    type="radio"
                                    name="simplifier-level"
                                    value="a1"
                                    checked
                                    onchange="updateSimplifierLabels()"
                                    class="mr-3 w-4 h-4 text-blue-600 focus:ring-blue-500"
                                >
                                <div class="flex-1">
                                    <div class="font-semibold text-slate-900">A1 (Beginner)</div>
                                    <div class="text-xs text-slate-600 mt-1">Present, simple past, basic vocab, short sentences</div>
                                </div>
                                <button
                                    onclick="openSimplifierPage(event, 'a1')"
                                    class="absolute top-2 right-2 p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-100 rounded transition-colors"
                                    title="Open A1 simplifier in new tab"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </button>
                            </label>
                            <label class="flex items-center cursor-pointer bg-slate-50 hover:bg-slate-100 rounded-lg p-3 border-2 border-transparent has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition-all flex-1 relative">
                                <input
                                    type="radio"
                                    name="simplifier-level"
                                    value="a2"
                                    onchange="updateSimplifierLabels()"
                                    class="mr-3 w-4 h-4 text-blue-600 focus:ring-blue-500"
                                >
                                <div class="flex-1">
                                    <div class="font-semibold text-slate-900">A2 (Elementary)</div>
                                    <div class="text-xs text-slate-600 mt-1">Past tenses, present continuous, expanded vocab</div>
                                </div>
                                <button
                                    onclick="openSimplifierPage(event, 'a2')"
                                    class="absolute top-2 right-2 p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-100 rounded transition-colors"
                                    title="Open A2 simplifier in new tab"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </button>
                            </label>
                        </div>

                        <!-- Feature Info Box -->
                        <div id="simplifier-features" class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-xs text-blue-900 space-y-1">
                                <div class="font-semibold mb-1">A1 Features:</div>
                                <div>âœ“ Present tense (presente)</div>
                                <div>âœ“ Simple past (pretÃ©rito perfeito)</div>
                                <div>âœ“ Immediate future (ir + infinitive)</div>
                                <div>âœ“ Basic vocabulary only</div>
                                <div>âœ“ Short, clear sentences (max 10-12 words)</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Section -->
                        <div>
                            <label for="simplifier-input" class="block text-sm font-semibold text-slate-700 mb-2">
                                Original Text (any language)
                            </label>
                            <textarea
                                id="simplifier-input"
                                rows="8"
                                class="w-full px-4 py-3 text-slate-900 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="Paste or type text in any language here..."
                            ></textarea>
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-xs text-slate-500">Supports text in any language</span>
                                <button
                                    onclick="simplifyText()"
                                    id="simplify-btn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Simplify to A1
                                </button>
                            </div>
                        </div>

                        <!-- Output Section -->
                        <div>
                            <label id="simplifier-output-label" for="simplifier-output" class="block text-sm font-semibold text-slate-700 mb-2">
                                Simplified A1-Level Portuguese
                            </label>
                            <div
                                id="simplifier-output"
                                class="w-full h-48 px-4 py-3 text-slate-900 bg-white border border-slate-300 rounded-lg shadow-sm overflow-y-auto"
                            >
                                <div class="flex items-center justify-center h-full text-slate-400">
                                    <div class="text-center">
                                        <svg class="w-16 h-16 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <p class="text-sm">Simplified text will appear here</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-end gap-2">
                                <button
                                    onclick="copySimplifiedText()"
                                    id="copy-btn"
                                    class="hidden bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium px-4 py-2 rounded-lg transition-colors text-sm"
                                >
                                    Copy Text
                                </button>
                                <button
                                    onclick="clearSimplifier()"
                                    class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium px-4 py-2 rounded-lg transition-colors text-sm"
                                >
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pronunciation Annotator Section -->
        <section class="mb-12">
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-3xl shadow-lg p-6 sm:p-8">
                <button
                    onclick="toggleAnnotator()"
                    class="w-full flex items-center justify-between text-left focus:outline-none focus:ring-2 focus:ring-green-500 rounded-lg"
                >
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Pronunciation Annotator</h2>
                            <p class="text-slate-600 text-sm mt-1">Add Brazilian pronunciation guides to any Portuguese text</p>
                        </div>
                    </div>
                    <svg id="annotator-chevron" class="w-6 h-6 text-slate-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div id="annotator-content" class="hidden mt-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Section -->
                        <div>
                            <label for="annotator-input" class="block text-sm font-semibold text-slate-700 mb-2">
                                Original Portuguese Text
                            </label>
                            <textarea
                                id="annotator-input"
                                rows="8"
                                class="w-full px-4 py-3 text-slate-900 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none font-mono"
                                placeholder="Eu sou americana. Eu moro em SÃ£o Paulo."
                            ></textarea>
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-xs text-slate-500">Paste clean Portuguese text</span>
                                <button
                                    onclick="annotateText()"
                                    id="annotate-btn"
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg"
                                >
                                    Add Annotations
                                </button>
                            </div>
                        </div>

                        <!-- Output Section -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label for="annotator-output" class="text-sm font-semibold text-slate-700">
                                    Annotated Text with Pronunciation
                                </label>
                                <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        id="substitution-mode"
                                        onchange="toggleAnnotationMode()"
                                        class="rounded border-gray-300 text-green-600 focus:ring-green-500"
                                    >
                                    <span>Substitution Mode</span>
                                </label>
                            </div>
                            <div
                                id="annotator-output"
                                class="w-full h-48 px-4 py-3 text-slate-900 bg-white border border-slate-300 rounded-lg shadow-sm overflow-y-auto font-mono text-sm"
                            >
                                <div class="flex items-center justify-center h-full text-slate-400">
                                    <div class="text-center">
                                        <svg class="w-16 h-16 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                        </svg>
                                        <p class="text-sm">Annotated text will appear here</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-end gap-2">
                                <button
                                    onclick="copyAnnotatedText()"
                                    id="copy-annotated-btn"
                                    class="hidden bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium px-4 py-2 rounded-lg transition-colors text-sm"
                                >
                                    Copy Text
                                </button>
                                <button
                                    onclick="clearAnnotator()"
                                    class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium px-4 py-2 rounded-lg transition-colors text-sm"
                                >
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="mt-6 p-4 bg-white rounded-lg border border-green-200">
                        <h3 class="text-sm font-semibold text-slate-900 mb-2">What this does:</h3>
                        <ul class="space-y-1 text-sm text-slate-600">
                            <li class="flex items-start gap-2">
                                <span class="text-green-600 mt-0.5">â€¢</span>
                                <span>Adds pronunciation guides to show how Brazilians actually pronounce words</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-green-600 mt-0.5">â€¢</span>
                                <span><strong>Bracket Mode:</strong> Shows annotations like trabalho<i class="text-blue-600">[u]</i> de<i class="text-blue-600">[dji]</i></span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-green-600 mt-0.5">â€¢</span>
                                <span><strong>Substitution Mode:</strong> Shows phonetic spelling like trabalh<span class="text-blue-600 font-semibold">u</span> <span class="text-blue-600 font-semibold">dji</span></span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-green-600 mt-0.5">â€¢</span>
                                <span><strong>Copy function:</strong> Always preserves raw format <code class="bg-slate-100 px-1 rounded">[_u_]</code> for pasting into syllabus files</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-green-600 mt-0.5">â€¢</span>
                                <span>Works <strong>instantly</strong> - no server needed, all processing happens in your browser!</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Hidden templates for the learning paths -->
        <div id="path-templates" class="hidden">
            <div id="a1-path" class="learning-path bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b-2 border-indigo-200 pb-3">A1 Path</h3>
                <ol>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-self-introduction">Self-Introduction Drill</a></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Regular Verbs</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-ar-verbs">Regular -ar Verbs</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-er-verbs">Regular -er Verbs</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-ir-verbs">Regular -ir Verbs</a></li></ul></div></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-irregular-verbs">Irregular Verbs Drill</a></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-contractions-articles">Contractions with Articles (de/em)</a></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Core Concepts</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-immediate-future">Immediate Future</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-noun-plurals">Noun Plurals</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-adjective-agreement">Adjective Agreement</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-ir-transportation">'Ir' + Transportation</a></li></ul></div></li>
                </ol>
            </div>
            <div id="a2-path" class="learning-path bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b-2 border-indigo-200 pb-3">A2 Path</h3>
                <ol>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-reflexive-verbs">Reflexive Verbs Drill</a></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Contractions w/ Pronouns</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-contractions-de">Contractions (de + pronouns)</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-contractions-em">Contractions (em + pronouns)</a></li></ul></div></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-present-continuous">Present Continuous Tense</a></li>
                    <li class="supplemental-step"><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-conversational-answers">Supplemental: Conversational Answers</a></li>
                </ol>
            </div>
            <div id="b1-path" class="learning-path bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b-2 border-indigo-200 pb-3">B1 Path</h3>
                <ol>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Past & Future Tenses</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-imperfect-tense">Imperfect Tense</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-future-tense">Future Tense</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-conditional-tense">Conditional Tense</a></li></ul></div></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Key Grammar</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-crase">Crase (Ã ) Tutor</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-demonstratives">Demonstratives</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-imperative">Imperative (Commands)</a></li></ul></div></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-present-subjunctive">Present Subjunctive Drill</a></li>
                    <li class="supplemental-step"><div class="learning-bundle"><h4 class="learning-bundle-title italic">Supplemental Bundle</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-syllable-stress">Syllable Stress</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-portuguese-for-spanish">For Spanish Speakers</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-grammar-for-spanish">Grammar for Spanish Speakers</a></li></ul></div></li>
                </ol>
            </div>
            <div id="b2-path" class="learning-path bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b-2 border-indigo-200 pb-3">B2 Path</h3>
                <ol>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Advanced Subjunctive</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-imperfect-subjunctive">Imperfect Subjunctive</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-future-subjunctive">Future Subjunctive</a></li></ul></div></li>
                    <li><a href="#" class="path-link text-blue-600 hover:underline font-semibold" data-target-id="drill-advanced-demonstratives">Advanced Demonstratives Drill</a></li>
                    <li><div class="learning-bundle"><h4 class="learning-bundle-title">Bundle: Sounding Natural</h4><ul class="space-y-1 ml-4 list-disc list-inside text-slate-600"><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-colloquial-speech">Colloquial Speech</a></li><li><a href="#" class="path-link text-blue-600 hover:underline" data-target-id="drill-phonetic-tutor">Phonetic Tutor</a></li></ul></div></li>
                </ol>
            </div>
        </div>

        <main>
            <!-- Search Bar -->
            <div class="my-8 max-w-md mx-auto">
                <label for="search-input" class="sr-only">Search for a drill</label>
                <input type="text" id="search-input" placeholder="Search for a drill..." class="w-full px-5 py-3 text-lg text-slate-700 bg-white border border-slate-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Topic Filter Controls -->
            <div id="topic-filter-controls" class="flex justify-center items-center gap-x-2 sm:gap-x-3 gap-y-2 mb-4 flex-wrap">
                 <span class="font-semibold text-slate-600">Topic:</span>
                 <button data-filter="all" class="topic-filter-btn active bg-blue-600 text-white rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="true">All</button>
                 <button data-filter="verbs" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Core Verbs</button>
                 <button data-filter="tenses" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Tenses & Structures</button>
                 <button data-filter="grammar" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Grammar & Prepositions</button>
                 <button data-filter="pronunciation" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Pronunciation</button>
                 <button data-filter="conversation" class="topic-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-pressed="false">Conversational Skills</button>
            </div>

            <!-- CEFR Level Filter Controls -->
            <div id="cefr-filter-controls" class="flex justify-center items-center gap-x-2 sm:gap-x-3 gap-y-2 mb-6 flex-wrap">
                 <span class="font-semibold text-slate-600">CEFR Level:</span>
                 <button data-filter="all" class="cefr-filter-btn active bg-indigo-600 text-white rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="true">All</button>
                 <button data-filter="a1" class="cefr-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="false">A1</button>
                 <button data-filter="a2" class="cefr-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="false">A2</button>
                 <button data-filter="b1" class="cefr-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="false">B1</button>
                 <button data-filter="b2" class="cefr-filter-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-pressed="false">B2</button>
            </div>

            <!-- Container for Path buttons and the dynamic display area -->
            <section id="learning-paths-section" class="mb-12">
                <!-- The buttons that trigger the paths -->
                <div id="path-triggers" class="flex justify-center items-center gap-x-2 sm:gap-x-3 gap-y-2 mb-6 flex-wrap">
                    <span class="font-semibold text-slate-600 basis-full sm:basis-auto text-center mb-2 sm:mb-0">Learning Paths:</span>
                    <button data-path-id="a1-path" class="path-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">A1 Path</button>
                    <button data-path-id="a2-path" class="path-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">A2 Path</button>
                    <button data-path-id="b1-path" class="path-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">B1 Path</button>
                    <button data-path-id="b2-path" class="path-btn bg-white text-slate-700 hover:bg-slate-100 rounded-full px-4 py-2 text-sm sm:text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">B2 Path</button>
                </div>
                
                <!-- This container will be populated by JavaScript when a button is clicked -->
                <div id="path-display-container" class="min-h-[1rem]"></div>
            </section>

            <!-- Drill Cards Grid -->
            <div id="drill-grid" class="relative grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div id="drill-ar-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Regular `-ar` Verb Drill</h2><p class="text-slate-600 text-base flex-grow">Practice the present and simple past of `-ar` verbs.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('regular-ar')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('regular-ar', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-er-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Regular `-er` Verb Drill</h2><p class="text-slate-600 text-base flex-grow">Practice the present and simple past of `-er` verbs.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('regular-er')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('regular-er', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-ir-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Regular `-ir` Verb Drill</h2><p class="text-slate-600 text-base flex-grow">Practice the present and simple past of `-ir` verbs.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('regular-ir')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('regular-ir', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-irregular-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Irregular Verb Drill</h2><p class="text-slate-600 text-base flex-grow">Memorize the forms for the most important irregular verbs (ser, estar, ir, ter, etc.).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('irregular-verbs')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('irregular-verbs', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-ser-estar" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Ser vs. Estar Drill</h2><p class="text-slate-600 text-base flex-grow">Master the fundamental difference between `ser` (permanent/identity) and `estar` (temporary/location/condition).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('ser-estar')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('ser-estar', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-reflexive-verbs" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“š Reflexive Verbs Drill</h2><p class="text-slate-600 text-base flex-grow">Practice choosing the correct reflexive pronoun (`me`, `se`, `nos`) to match the subject.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('reflexive-verbs')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('reflexive-verbs', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-subject-identification" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="verbs" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Core Verbs</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸŽ¯ Subject Identification</h2><p class="text-slate-600 text-base flex-grow">Reverse conjugation practice: identify which subject(s) match a given verb form. Learn to recognize patterns by endings.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('subject-identification')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('subject-identification', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-immediate-future" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Immediate Future Drill</h2><p class="text-slate-600 text-base flex-grow">Master the "going to" future (`ir` + infinitive), the most common future form.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('immediate-future')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('immediate-future', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-present-continuous" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Present Continuous Tense</h2><p class="text-slate-600 text-base flex-grow">Master the Portuguese "-ing" form (`-ndo`) using `estar` + gerund.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('present-continuous')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('present-continuous', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-preterite-tense" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">â®ï¸ Preterite Tense (Simple Past)</h2><p class="text-slate-600 text-base flex-grow">Master completed past actions: "I ate", "She went". Learn regular patterns (-ar: -ei/-ou, -er/-ir: -i/-iu) and common irregulars (fiz, fui, tive).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('preterite-tense')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('preterite-tense', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-imperfect-tense" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Imperfect Tense Drill</h2><p class="text-slate-600 text-base flex-grow">Practice the simple form ("used to do"), the past continuous ("was doing"), and the past intent ("was going to do").</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('imperfect-tense')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('imperfect-tense', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-future-tense" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Future Tense Drill</h2><p class="text-slate-600 text-base flex-grow">Master the Portuguese "will" tense (`-ei`, `-Ã¡` endings). Covers regular and key irregular verbs.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('future-tense')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('future-tense', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-conditional-tense" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Conditional Tense Drill</h2><p class="text-slate-600 text-base flex-grow">Master the Portuguese "would" tense (`-ia` endings). Covers regular and key irregular verbs.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('conditional-tense')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('conditional-tense', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-present-subjunctive" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Present Subjunctive Drill</h2><p class="text-slate-600 text-base flex-grow">Master the subjunctive after triggers like `Espero que...` and `Quero que...`.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('present-subjunctive')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('present-subjunctive', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-imperfect-subjunctive" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Imperfect Subjunctive Drill</h2><p class="text-slate-600 text-base flex-grow">Master hypothetical "if" clauses (`Se eu fosse...`) for regular and irregular verbs.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('imperfect-subjunctive')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('imperfect-subjunctive', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-future-subjunctive" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Future Subjunctive Drill</h2><p class="text-slate-600 text-base flex-grow">Master hypothetical future situations using `Quando...` and `Se...`.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('future-subjunctive')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('future-subjunctive', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-imperative" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="tenses" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-cyan-100 text-cyan-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Tenses & Structures</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¡ Imperative Drill</h2><p class="text-slate-600 text-base flex-grow">Master the Portuguese command form. Tests the formal (`fale`) and provides notes on the spoken form (`fala`).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('imperative')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('imperative', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-articles" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“„ Articles (Definite & Indefinite)</h2><p class="text-slate-600 text-base flex-grow">Master o/a/os/as (the) and um/uma/uns/umas (a/an/some) with proper gender/number agreement. Learn when to use and omit articles.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('articles')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('articles', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-noun-plurals" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Noun Plural Tutor</h2><p class="text-slate-600 text-base flex-grow">Master the rules for forming noun plurals, with analogies for Spanish speakers.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('noun-plurals')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('noun-plurals', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-adjective-agreement" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Adjective Gender & Number Agreement</h2><p class="text-slate-600 text-base flex-grow">Practice making adjectives match the gender and number of the nouns they describe.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('adjective-agreement')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('adjective-agreement', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-numbers" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”¢ Numbers (Cardinal & Ordinal)</h2><p class="text-slate-600 text-base flex-grow">Master Portuguese numbers with gender agreement (`um/uma`, `dois/duas`, `duzentos/duzentas`), ordinals, and real-world usage (prices, dates, ages).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('numbers')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('numbers', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-colors" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸŽ¨ Colors (Cores)</h2><p class="text-slate-600 text-base flex-grow">Master Portuguese colors with proper gender/number agreement. Learn variable colors (vermelho/vermelha) vs invariable (azul, verde), shades (claro/escuro), and natural usage.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('colors')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('colors', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-days-of-week" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“… Days of the Week (Dias da Semana)</h2><p class="text-slate-600 text-base flex-grow">Master Portuguese days with proper prepositions and articles. Learn "na segunda-feira" (on Monday) vs "Ã s segundas" (on Mondays), gender differences (na vs no), and common expressions like "atÃ© segunda!"</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('days-of-week')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('days-of-week', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-time-expressions" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ• Time Expressions</h2><p class="text-slate-600 text-base flex-grow">Master telling time, days of the week, months, and time vocabulary. Learn "Ã‰ uma hora" vs "SÃ£o trÃªs horas", days (segunda-feira), and expressions (hoje, amanhÃ£, de manhÃ£).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('time-expressions')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('time-expressions', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-possessives" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ‘¤ Possessive Adjectives & Pronouns</h2><p class="text-slate-600 text-base flex-grow">Master `meu/minha`, `seu/sua`, `nosso/nossa` with gender/number agreement. Learn `dele/dela` for clarity: "his book" = `o livro dele`.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('possessives')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('possessives', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-todo-tudo" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">âœ¨ Todo vs Tudo</h2><p class="text-slate-600 text-base flex-grow">Master the difference between `todo/toda/todos/todas` (all/every) and `tudo` (everything). Learn agreement patterns and common phrases like `todo mundo`, `tudo bem`.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('todo-tudo')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('todo-tudo', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-muito" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ“Š Muito Agreement</h2><p class="text-slate-600 text-base flex-grow">Learn when `muito` agrees (muito/muita/muitos/muitas with nouns) vs when it stays invariable (very/a lot with adjectives/verbs).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('muito')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('muito', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-demonstratives" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Demonstrative Pronouns Drill</h2><p class="text-slate-600 text-base flex-grow">Master the tricky distinction between `este` (near me), `esse` (near you), and `aquele` (over there).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('demonstratives')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('demonstratives', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-interrogatives" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">â“ Interrogative Pronouns</h2><p class="text-slate-600 text-base flex-grow">Master question words like `quem`, `o que`, `qual`, `quando`, `onde`, and learn key distinctions (`o que` vs `qual`, `onde` vs `aonde`).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('interrogatives')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('interrogatives', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-e-que-questions" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Ã‰ que - Emphatic Questions</h2><p class="text-slate-600 text-base flex-grow">Learn to transform questions using `Ã© que` for emphasis: `Onde vocÃª mora?` â†’ `Onde Ã© que vocÃª mora?`. Very common in Brazilian Portuguese!</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('e-que-questions')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('e-que-questions', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-ir-transportation" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— 'Ir' + Transportation Drill</h2><p class="text-slate-600 text-base flex-grow">Practice using the verb 'ir' (to go) with different modes of transportation like 'de carro', 'a pÃ©', and 'de Uber'.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('ir-transportation')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('ir-transportation', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-por-vs-para" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">âš–ï¸ Por vs Para</h2><p class="text-slate-600 text-base flex-grow">Master the tricky distinction between `por` (reason, price, means, duration) and `para` (purpose, destination, recipient, deadline). Both mean "for" but with different uses!</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('por-vs-para')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('por-vs-para', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-common-prepositions" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”¤ Common Prepositions</h2><p class="text-slate-600 text-base flex-grow">Master essential prepositions: em (in/at), de (of/from), para (to/for), com (with), sem (without), sobre (about), entre (between), atÃ© (until), desde (since).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('common-prepositions')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('common-prepositions', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-question-words" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">â“ Question Words</h2><p class="text-slate-600 text-base flex-grow">Master Portuguese interrogatives: quem (who), o que (what), quando (when), onde (where), como (how), por que (why), qual (which), quanto (how much/many).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('question-words')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('question-words', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-advanced-demonstratives" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Advanced Demonstratives</h2><p class="text-slate-600 text-base flex-grow">Master conversational uses, including discourse proximity and the common 'este' -> 'esse' conflation.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('advanced-demonstratives')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('advanced-demonstratives', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-crase" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Crase (`Ã `) Tutor</h2><p class="text-slate-600 text-base flex-grow">A dedicated drill for mastering the crase. Learn when to use `Ã ` and `Ã s` with instant feedback.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('crase')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('crase', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-contractions-de" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Contraction Trainer (`dele`/`dela`)</h2><p class="text-slate-600 text-base flex-grow">Practice possessives (`his book`) and verb objects (`I like him`).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('contractions-de')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('contractions-de', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-contractions-em" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Contraction Trainer (`nele`/`nela`)</h2><p class="text-slate-600 text-base flex-grow">Practice location (`in it`) and verb objects (`I think about him`).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('contractions-em')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('contractions-em', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-contractions-articles" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="grammar" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Grammar & Prepositions</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”— Contractions with Articles (de/em)</h2><p class="text-slate-600 text-base flex-grow">Learn how "de" and "em" contract with articles using step-by-step fill-in-the-blank drills.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('contractions-articles')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('contractions-articles', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-syllable-stress" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="pronunciation" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-orange-100 text-orange-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Pronunciation</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”Š Syllable Stress Drill</h2><p class="text-slate-600 text-base flex-grow">Master Portuguese syllable stress for perfect pronunciation. Learn the rules for stress and accent marks.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('syllable-stress')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('syllable-stress', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-phonetics-br" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="pronunciation" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-orange-100 text-orange-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Pronunciation</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ”Š PT-BR Phonetic Tutor</h2><p class="text-slate-600 text-base flex-grow">Learn how Brazilian Portuguese transforms from written to spoken form. Master palatalization, vowel reduction, and more.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('phonetics-br')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('phonetics-br', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-colloquial-speech" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="b2"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Colloquial Speech Drill</h2><p class="text-slate-600 text-base flex-grow">Rewrite formal sentences the way people actually talk. Master reductions (vocÃªâ†’cÃª, estarâ†’tÃ¡) and mergers (vocÃª estÃ¡â†’cÃª tÃ¡).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('colloquial-speech')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('colloquial-speech', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-conversational-answers" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="a2"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Conversational Answers Drill</h2><p class="text-slate-600 text-base flex-grow">Answer yes/no questions by repeating the verb (VocÃª fala? â†’ Falo.). Includes BP emphatic forms (Falo, sim!).</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('conversational-answers')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('conversational-answers', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-self-introduction" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="a1"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Self-Introduction Drill</h2><p class="text-slate-600 text-base flex-grow">For absolute beginners. Build your first sentences: name, profession, nationality, city, languages, workplace.</p></div><div class="p-6 bg-slate-50">
                        <button onclick="openDrillChat('self-introduction')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('self-introduction', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-portuguese-for-spanish" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Portuguese for Spanish Speakers</h2><p class="text-slate-600 text-base flex-grow">Leverage your Spanish to learn Portuguese faster. Focus on false friends, vocabulary gaps, pronunciation, and grammar differences.</p></div><div class="p-6 bg-slate-50">
                    <button onclick="openDrillChat('portuguese-for-spanish')" class="w-full text-center bg-green-600 text-white rounded-lg px-4 py-2.5 font-semibold hover:bg-green-700 transition-colors text-sm mb-2">Start</button>
                        <button onclick="copyDrillLink('portuguese-for-spanish', this)" class="w-full text-center bg-slate-200 text-slate-700 rounded-lg px-4 py-2 font-medium hover:bg-slate-300 transition-colors text-sm">ðŸ”— Copy Link</button>
                    </div></div>
                <div id="drill-grammar-for-spanish" class="drill-card flex flex-col bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-topic="conversation" data-cefr="b1"><div class="p-6 flex-grow"><span class="inline-block bg-teal-100 text-teal-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">Conversational Skills</span><h2 class="text-xl font-bold text-slate-900 mb-2">ðŸ’¬ Grammar for Spanish Speakers</h2><p class="text-slate-600 text-base flex-grow">A focused drill on the key grammatical differences between Spanish and Portuguese, like contractions and pronoun placement.</p></div><div class="p-6 bg-slate-50"><a href="#" target="_blank" class="block w-full text-center bg-gray-400 text-white rounded-lg px-4 py-2.5 font-semibold cursor-not-allowed" aria-disabled="true">Coming Soon</a></div></div>
                <div id="no-results" class="hidden col-span-1 md:col-span-2 lg:col-span-3 text-center py-16"><h3 class="text-2xl font-semibold text-slate-600">Nenhum resultado</h3><p class="text-slate-500 mt-2">No drills matched your search. Try removing some filters or changing your search term.</p></div>
            </div>
        </main>
    </div>

    <footer class="bg-slate-100 border-t border-slate-200">
        <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 text-center text-slate-500">
            <p>&copy; 2025 Gil Klein. All Rights Reserved.</p>
            <p class="text-sm mt-1">Made with â¤ï¸ in New York City.</p>
        </div>
    </footer>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cefrFilterControls = document.getElementById('cefr-filter-controls');
            const topicFilterControls = document.getElementById('topic-filter-controls');
            const drillCards = document.querySelectorAll('.drill-card');
            const searchInput = document.getElementById('search-input');
            const noResultsMessage = document.getElementById('no-results');
            
            // NEW: Path display logic variables
            const pathTriggers = document.getElementById('path-triggers');
            const pathDisplayContainer = document.getElementById('path-display-container');
            const pathButtons = pathTriggers.querySelectorAll('.path-btn');

            function filterAndSearch() {
                const activeCefrFilter = cefrFilterControls.querySelector('.active').dataset.filter;
                const activeTopicFilter = topicFilterControls.querySelector('.active').dataset.filter;
                const searchTerm = searchInput.value.toLowerCase().trim();
                let visibleCount = 0;

                drillCards.forEach(card => {
                    const cardCefr = card.dataset.cefr;
                    const cardTopic = card.dataset.topic;
                    const cardTitle = card.querySelector('h2').textContent.toLowerCase();
                    const cardDescription = card.querySelector('p').textContent.toLowerCase();

                    const matchesCefr = activeCefrFilter === 'all' || cardCefr === activeCefrFilter;
                    const matchesTopic = activeTopicFilter === 'all' || cardTopic === activeTopicFilter;
                    const matchesSearch = cardTitle.includes(searchTerm) || cardDescription.includes(searchTerm);

                    if (matchesCefr && matchesTopic && matchesSearch) {
                        card.classList.remove('hidden');
                        visibleCount++;
                    } else {
                        card.classList.add('hidden');
                    }
                });

                noResultsMessage.classList.toggle('hidden', visibleCount > 0);
            }

            function setupFilter(controlsId, buttonClass, activeBgColor) {
                const controls = document.getElementById(controlsId);
                const buttons = controls.querySelectorAll(`.${buttonClass}`);
                
                controls.addEventListener('click', (event) => {
                    const targetButton = event.target.closest(`.${buttonClass}`);
                    if (!targetButton) return;

                    buttons.forEach(button => {
                        const isActive = button === targetButton;
                        button.classList.toggle('active', isActive);
                        button.classList.toggle(activeBgColor, isActive);
                        button.classList.toggle('text-white', isActive);
                        button.classList.toggle('bg-white', !isActive);
                        button.classList.toggle('text-slate-700', !isActive);
                        button.setAttribute('aria-pressed', isActive);
                    });
                    
                    filterAndSearch();
                });
            }

            setupFilter('cefr-filter-controls', 'cefr-filter-btn', 'bg-indigo-600');
            setupFilter('topic-filter-controls', 'topic-filter-btn', 'bg-blue-600');

            searchInput.addEventListener('input', filterAndSearch);
            
            // NEW: Learning Path display logic
            pathTriggers.addEventListener('click', (event) => {
                const targetButton = event.target.closest('.path-btn');
                if (!targetButton) return;

                const pathId = targetButton.dataset.pathId;
                const wasActive = targetButton.classList.contains('bg-indigo-600');

                // Reset all path buttons
                pathButtons.forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-white', 'text-slate-700');
                });

                // Clear the display container
                pathDisplayContainer.innerHTML = '';

                // If the button was not active, make it active and show the path
                if (!wasActive) {
                    targetButton.classList.add('bg-indigo-600', 'text-white');
                    targetButton.classList.remove('bg-white', 'text-slate-700');
                    const pathTemplate = document.getElementById(pathId);
                    if (pathTemplate) {
                        pathDisplayContainer.innerHTML = pathTemplate.outerHTML;
                    }
                }
            });

            // Event delegation for path-link clicks
            pathDisplayContainer.addEventListener('click', (event) => {
                const pathLink = event.target.closest('.path-link');
                if (pathLink) {
                    event.preventDefault();
                    const targetId = pathLink.dataset.targetId;
                    const targetCard = document.getElementById(targetId);

                    // Remove highlight from any other card
                    const currentlyHighlighted = document.querySelector('.drill-card.highlight');
                    if (currentlyHighlighted) {
                        currentlyHighlighted.classList.remove('highlight');
                    }

                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetCard.classList.add('highlight');
                    }
                }
            });

            filterAndSearch();

            // Check for drill URL parameters and auto-open chat
            const urlParams = new URLSearchParams(window.location.search);
            const drillParam = urlParams.get('drill');        // Single drill
            const drillsParam = urlParams.get('drills');      // Multiple drills (comma-separated)
            const simplifierParam = urlParams.get('simplifier'); // Simplifier with level (a1 or a2)

            if (drillParam) {
                // Single drill mode
                setTimeout(() => {
                    openDrillChat(drillParam);

                    // Scroll to and highlight the drill card
                    const targetCard = document.getElementById('drill-' + drillParam);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetCard.classList.add('highlight');
                    }
                }, 300);
            } else if (drillsParam) {
                // Multiple drills mode
                const drillIds = drillsParam.split(',').map(id => id.trim()).filter(id => id);

                if (drillIds.length > 0) {
                    setTimeout(async () => {
                        // Open empty session first
                        openEmptySession();

                        // Small delay to let empty session initialize
                        await new Promise(resolve => setTimeout(resolve, 500));

                        // Add each drill to the session sequentially
                        for (const drillId of drillIds) {
                            try {
                                await addDrillToChat(drillId);
                                // Small delay between adding drills
                                await new Promise(resolve => setTimeout(resolve, 300));
                            } catch (error) {
                                console.error(`Failed to add drill ${drillId}:`, error);
                            }
                        }

                        // Scroll to and highlight the first drill card
                        const targetCard = document.getElementById('drill-' + drillIds[0]);
                        if (targetCard) {
                            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            targetCard.classList.add('highlight');
                        }
                    }, 300);
                }
            }

            // Check for simplifier URL parameter
            if (simplifierParam && (simplifierParam === 'a1' || simplifierParam === 'a2')) {
                setTimeout(() => {
                    // Open simplifier section if it's closed
                    const content = document.getElementById('simplifier-content');
                    const chevron = document.getElementById('simplifier-chevron');

                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        chevron.classList.add('rotate-180');
                    }

                    // Select the appropriate level radio button
                    const radioButton = document.querySelector(`input[name="simplifier-level"][value="${simplifierParam}"]`);
                    if (radioButton) {
                        radioButton.checked = true;
                        // Update all labels and features to match selected level
                        updateSimplifierLabels();
                    }

                    // Scroll to simplifier section
                    const simplifierSection = content.closest('section');
                    if (simplifierSection) {
                        simplifierSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 300);
            }
        });
    </script>

    <!-- Chat Modal -->
    <div id="chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-2">
        <div id="chat-container" class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl h-[90vh] flex flex-col transition-all duration-300 ease-in-out">
            <!-- Header -->
            <div class="p-4 border-b border-slate-200">
                <!-- Drill Title Row -->
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-green-600 font-bold">PT</span>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div id="chat-drill-title" class="font-semibold text-slate-900"></div>
                    </div>
                </div>
                <!-- Buttons Row -->
                <div class="flex items-center justify-between flex-wrap gap-2">
                    <div class="flex items-center space-x-2">
                        <button onclick="openDrillSelector()" class="text-green-600 hover:text-green-700 p-2 rounded-lg hover:bg-green-50 text-sm font-medium">
                            + Add Drill
                        </button>
                        <button onclick="startNewSession()" class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 text-sm font-medium">
                            New Session
                        </button>
                        <button id="share-chat-btn" onclick="shareChatState(this)" class="text-purple-600 hover:text-purple-700 p-2 rounded-lg hover:bg-purple-50 text-sm font-medium" title="Share this chat session">
                            ðŸ”— Share
                        </button>
                    </div>
                    <div class="flex items-center gap-1">
                        <button id="maximize-chat-btn" onclick="toggleMaximizeChat()" class="text-slate-400 hover:text-slate-600 p-2 rounded-lg hover:bg-slate-100" title="Maximize">
                            <svg id="maximize-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                            </svg>
                            <svg id="minimize-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"></path>
                            </svg>
                        </button>
                        <button onclick="closeDrillChat()" class="text-slate-400 hover:text-slate-600 p-2 rounded-lg hover:bg-slate-100" title="Close">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Drills Badges -->
            <div id="active-drills-container" class="hidden px-4 pt-3 pb-2 border-b border-slate-200 bg-slate-50">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs font-medium text-slate-600">Active Drills:</span>
                    <div id="active-drills-badges" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-green-600 text-sm font-bold">AI</span>
                    </div>
                    <div class="bg-slate-100 rounded-2xl p-3 max-w-2xl">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-600"></div>
                            <div id="loading-message" class="text-slate-600">Starting your drill session...</div>
                        </div>
                        <div class="text-xs text-slate-500 mt-2">This may take up to 30 seconds...</div>
                    </div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="border-t border-slate-200 p-4">
                <div class="flex space-x-3">
                    <input 
                        type="text" 
                        id="chat-input" 
                        placeholder="Type your answer or message..."
                        class="flex-1 border border-slate-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        disabled
                    >
                    <button 
                        onclick="sendChatMessage()"
                        id="chat-send-btn"
                        class="bg-green-600 text-white rounded-full px-6 py-2 font-semibold hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Drill Selector Modal -->
    <div id="drill-selector-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200">
                <h2 class="text-2xl font-bold text-slate-900">Add Another Drill</h2>
                <button onclick="closeDrillSelector()" class="text-slate-400 hover:text-slate-600 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Drill List -->
            <div id="drill-selector-list" class="p-6 space-y-3">
                <!-- Drills will be populated here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
// Chat functionality
let currentChatSession = null;
let currentDrillId = null;
let activeDrills = []; // Array of drill IDs active in current session
let drillSessions = {}; // Store separate sessions for each drill type

// Function to reset all sessions - for debugging
function resetAllSessions() {
  console.log('Resetting all sessions');
  drillSessions = {};
  currentChatSession = null;
  currentDrillId = null;
  activeDrills = [];
}

// Function to start a new session for the current drill
async function startNewSession() {
  if (!currentDrillId) return;

  console.log('Starting new session for drill:', currentDrillId);
  console.log('Before clearing - drillSessions:', drillSessions);

  // Clear the current drill's session completely
  delete drillSessions[currentDrillId];
  currentChatSession = null;
  activeDrills = []; // Clear active drills array

  console.log('After clearing - drillSessions:', drillSessions);

  // Clear the UI immediately
  const messagesContainer = document.getElementById('chat-messages');
  messagesContainer.innerHTML = '<div class="flex items-start space-x-3"><div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-green-600 text-sm font-bold">AI</span></div><div class="bg-slate-100 rounded-2xl p-3 max-w-2xl"><div id="loading-message" class="text-slate-600">Starting fresh session...</div></div></div>';

  // Start completely new session
  setTimeout(() => {
    openDrillChat(currentDrillId);
  }, 500);
}

// A1 Simplifier Functions
function toggleSimplifier() {
  const content = document.getElementById('simplifier-content');
  const chevron = document.getElementById('simplifier-chevron');

  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    chevron.classList.add('rotate-180');
  } else {
    content.classList.add('hidden');
    chevron.classList.remove('rotate-180');
  }
}

async function simplifyText() {
  const input = document.getElementById('simplifier-input');
  const output = document.getElementById('simplifier-output');
  const simplifyBtn = document.getElementById('simplify-btn');
  const copyBtn = document.getElementById('copy-btn');

  const inputText = input.value.trim();

  if (!inputText) {
    output.innerHTML = '<div class="text-red-600 p-4">Please enter some text to simplify.</div>';
    return;
  }

  // Get selected level
  const selectedLevel = document.querySelector('input[name="simplifier-level"]:checked').value;
  const levelUpper = selectedLevel.toUpperCase();
  const drillId = selectedLevel === 'a1' ? 'a1-simplifier' : 'a2-simplifier';

  // Disable button and show loading
  simplifyBtn.disabled = true;
  const originalButtonText = simplifyBtn.textContent;
  simplifyBtn.textContent = 'Simplifying...';
  copyBtn.classList.add('hidden');

  output.innerHTML = `<div class="flex items-center justify-center h-full"><div class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"></div><p class="text-slate-600">Simplifying text to ${levelUpper} level...</p></div></div>`;

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 second timeout

    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: null,
        drillId: drillId,
        message: inputText,
        isNewSession: true
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text().catch(() => 'Unknown error');
      throw new Error(`Server error (${response.status}): ${errorText}`);
    }

    const data = await response.json();

    // Display the simplified text
    output.innerHTML = `<div class="prose prose-slate max-w-none whitespace-pre-wrap">${escapeHtml(data.response)}</div>`;

    // Show copy button
    copyBtn.classList.remove('hidden');

  } catch (error) {
    console.error('Error simplifying text:', error);

    let errorMessage = 'Connection error. ';
    if (error.name === 'AbortError') {
      errorMessage = 'Request timed out. ';
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'Network error. Check your connection. ';
    } else if (error.message.includes('Server error')) {
      errorMessage = error.message + ' ';
    }

    output.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4"><p class="text-red-800 text-sm mb-3">${errorMessage}</p><button onclick="simplifyText()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition-colors text-sm">Retry</button></div>`;

  } finally {
    simplifyBtn.disabled = false;
    simplifyBtn.textContent = originalButtonText;
  }
}

function updateSimplifierLabels() {
  const selectedLevel = document.querySelector('input[name="simplifier-level"]:checked').value;
  const levelUpper = selectedLevel.toUpperCase();
  const levelName = selectedLevel === 'a1' ? 'A1 (Beginner)' : 'A2 (Elementary)';

  // Update button text
  const simplifyBtn = document.getElementById('simplify-btn');
  simplifyBtn.textContent = `Simplify to ${levelUpper}`;

  // Update output label
  const outputLabel = document.getElementById('simplifier-output-label');
  outputLabel.textContent = `Simplified ${levelUpper}-Level Portuguese`;

  // Update feature info box
  const featuresBox = document.getElementById('simplifier-features');
  if (selectedLevel === 'a1') {
    featuresBox.innerHTML = `
      <div class="text-xs text-blue-900 space-y-1">
        <div class="font-semibold mb-1">A1 Features:</div>
        <div>âœ“ Present tense (presente)</div>
        <div>âœ“ Simple past (pretÃ©rito perfeito)</div>
        <div>âœ“ Immediate future (ir + infinitive)</div>
        <div>âœ“ Basic vocabulary only</div>
        <div>âœ“ Short, clear sentences (max 10-12 words)</div>
      </div>
    `;
  } else {
    featuresBox.innerHTML = `
      <div class="text-xs text-blue-900 space-y-1">
        <div class="font-semibold mb-1">A2 Features:</div>
        <div>âœ“ Past tenses (Perfeito & Imperfeito)</div>
        <div>âœ“ Present Continuous (estar + gerÃºndio)</div>
        <div>âœ“ Immediate future (ir + infinitive)</div>
        <div>âœ“ Expanded vocabulary & cognates</div>
        <div>âœ“ Longer sentences (up to 15-20 words)</div>
        <div>âœ“ Relative clauses with 'que'</div>
      </div>
    `;
  }
}

function openSimplifierPage(event, level) {
  event.preventDefault();
  event.stopPropagation();

  const url = `/simplifier.html?level=${level}`;
  window.open(url, '_blank');
}

function copySimplifiedText() {
  const output = document.getElementById('simplifier-output');
  const textContent = output.textContent.trim();

  if (textContent) {
    navigator.clipboard.writeText(textContent).then(() => {
      const copyBtn = document.getElementById('copy-btn');
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyBtn.textContent = originalText;
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy text:', err);
      alert('Failed to copy text to clipboard');
    });
  }
}

function clearSimplifier() {
  const input = document.getElementById('simplifier-input');
  const output = document.getElementById('simplifier-output');
  const copyBtn = document.getElementById('copy-btn');

  input.value = '';
  copyBtn.classList.add('hidden');

  output.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400"><div class="text-center"><svg class="w-16 h-16 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p class="text-sm">Simplified text will appear here</p></div></div>';
}

// Pronunciation Annotator Functions
function toggleAnnotator() {
  const content = document.getElementById('annotator-content');
  const chevron = document.getElementById('annotator-chevron');

  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    chevron.classList.add('rotate-180');
  } else {
    content.classList.add('hidden');
    chevron.classList.remove('rotate-180');
  }
}

function formatBracketMode(annotated) {
  // Bracket mode: Show annotations in brackets [notation]
  return annotated
    .replace(/\/([^/]+)\//g, '<i class="text-blue-600">[$1]</i>')  // Italic annotations (blue)
    .replace(/~~([^~]+)~~/g, '<s class="text-gray-400">$1</s>')       // Strikethrough (gray)
    .replace(/\n/g, '<br>');                                            // Line breaks
}

function formatSubstitutionMode(annotated) {
  // Substitution mode: Replace original text with phonetic realization
  let result = annotated;

  // Use [^] instead of \w to match any character including Portuguese special chars (Ã£, Ãµ, Ã§, etc.)

  // STEP 1: Handle compound transformations first (most specific patterns)

  // Final -te â†’ tchi (more specific than -e â†’ i)
  result = result.replace(/([^\s]+)te\/tchi\//gi, (match, stem) => {
    return stem + '<span class="text-blue-600 font-semibold">tchi</span>';
  });

  // Final -de â†’ dji (more specific than -e â†’ i, but not standalone "de")
  result = result.replace(/([^\s]+)de\/dji\//gi, (match, stem) => {
    return stem + '<span class="text-blue-600 font-semibold">dji</span>';
  });

  // Verb -am â†’ Ã£wn
  result = result.replace(/([^\s]+)am\/Ã£wn\//gi, (match, stem) => {
    return stem + '<span class="text-blue-600 font-semibold">Ã£wn</span>';
  });

  // STEP 2: Handle nasal patterns

  // -em nasal patterns (tem, bem, etc.)
  result = result.replace(/\b(tem|quem|sem|bem|cem|nem|em)\/([^/]+)\//gi, (match, word, sound) => {
    return `<span class="text-blue-600 font-semibold">${sound}</span>`;
  });

  // tambÃ©m, alguÃ©m, ninguÃ©m (show full word with ending highlighted)
  result = result.replace(/([^\s]+Ã©m)\/eyn\//gi, (match, word) => {
    const stem = word.slice(0, -2);
    return stem + '<span class="text-blue-600 font-semibold">eyn</span>';
  });

  // Short nasal words: com, som, bom
  result = result.replace(/\b(com|som|bom)\/([^/]+)\//gi, (match, word, sound) => {
    return `<span class="text-blue-600 font-semibold">${sound}</span>`;
  });

  // um/uma â†’ Å©m/Å©ma
  result = result.replace(/\b(um|uma|algum|alguma|nenhum|nenhuma)\/([^/]+)\//gi, (match, word, sound) => {
    return `<span class="text-blue-600 font-semibold">${sound}</span>`;
  });

  // STEP 3: Handle palatalization

  // de â†’ dji (complete replacement)
  result = result.replace(/\bde\/dji\//gi, '<span class="text-blue-600 font-semibold">dji</span>');

  // STEP 4: Handle final vowel changes (must be after compound patterns)

  // Final -os â†’ us (before -o to avoid conflicts)
  result = result.replace(/([^\s]+)os\/us\//gi, (match, stem) => {
    return stem + '<span class="text-blue-600 font-semibold">us</span>';
  });

  // Final -o â†’ u (includes words with special chars like "Ã§Ã£o")
  result = result.replace(/([^\s]+)o\/u\//gi, (match, stem) => {
    return stem + '<span class="text-blue-600 font-semibold">u</span>';
  });

  // Single letter 'o' (article) - special case
  result = result.replace(/\bo\/u\//gi, '<span class="text-blue-600 font-semibold">u</span>');

  // Final -es â†’ is (before -e to avoid conflicts)
  result = result.replace(/([^\s]+)es\/is\//gi, (match, stem) => {
    return stem + '<span class="text-blue-600 font-semibold">is</span>';
  });

  // Final -e â†’ i (includes words with special chars)
  result = result.replace(/([^\s]+)e\/i\//gi, (match, stem) => {
    return stem + '<span class="text-blue-600 font-semibold">i</span>';
  });

  // Single letter 'e' (conjunction) - special case
  result = result.replace(/\be\/i\//gi, '<span class="text-blue-600 font-semibold">i</span>');

  // Final -l â†’ u (L vocalization - replace L with u)
  result = result.replace(/([^\s]+)l\/u\//gi, (match, stem) => {
    return stem + '<span class="text-blue-600 font-semibold">u</span>';
  });

  // STEP 5: Clean up any remaining annotations (fallback)
  result = result.replace(/\/([^/]+)\//g, '<span class="text-blue-600 font-semibold">$1</span>');
  result = result.replace(/~~([^~]+)~~/g, '$1');

  // Line breaks
  result = result.replace(/\n/g, '<br>');

  return result;
}

function annotateText() {
  const input = document.getElementById('annotator-input');
  const output = document.getElementById('annotator-output');
  const copyBtn = document.getElementById('copy-annotated-btn');
  const substitutionMode = document.getElementById('substitution-mode').checked;

  const inputText = input.value.trim();

  if (!inputText) {
    output.innerHTML = '<div class="text-red-600 p-4">Please enter some Portuguese text to annotate.</div>';
    return;
  }

  // Annotate the text (instant, client-side)
  try {
    const annotated = annotatePronunciation(inputText, false);

    // Store the raw annotated text for copying (with underscores)
    output.dataset.rawText = annotated;

    // Format based on selected mode
    const formatted = substitutionMode ? formatSubstitutionMode(annotated) : formatBracketMode(annotated);
    output.innerHTML = `<div class="whitespace-pre-wrap">${formatted}</div>`;

    // Show copy button
    copyBtn.classList.remove('hidden');
  } catch (error) {
    console.error('Error annotating text:', error);
    output.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4"><p class="text-red-800 text-sm">Error annotating text. Please try again.</p></div>`;
  }
}

function toggleAnnotationMode() {
  // Re-render the output if we have annotated text
  const output = document.getElementById('annotator-output');
  const rawText = output.dataset.rawText;

  if (rawText) {
    const substitutionMode = document.getElementById('substitution-mode').checked;
    const formatted = substitutionMode ? formatSubstitutionMode(rawText) : formatBracketMode(rawText);
    output.innerHTML = `<div class="whitespace-pre-wrap">${formatted}</div>`;
  }
}

function copyAnnotatedText() {
  const output = document.getElementById('annotator-output');

  // Copy the raw text with underscores (for pasting into syllabus files)
  // Not the HTML-formatted version shown on screen
  const textToCopy = output.dataset.rawText || output.textContent || output.innerText;

  navigator.clipboard.writeText(textToCopy).then(() => {
    const copyBtn = document.getElementById('copy-annotated-btn');
    const originalText = copyBtn.textContent;
    copyBtn.textContent = 'Copied!';
    setTimeout(() => {
      copyBtn.textContent = originalText;
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy text:', err);
    alert('Failed to copy text to clipboard');
  });
}

function clearAnnotator() {
  const input = document.getElementById('annotator-input');
  const output = document.getElementById('annotator-output');
  const copyBtn = document.getElementById('copy-annotated-btn');

  input.value = '';
  copyBtn.classList.add('hidden');

  output.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400"><div class="text-center"><svg class="w-16 h-16 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg><p class="text-sm">Annotated text will appear here</p></div></div>';
}

// Function to start an empty session with no drills
function startEmptySession() {
  // Create a unique session ID for empty sessions
  const emptySessionId = 'empty-' + Date.now();

  // Reset all session data
  currentChatSession = null;
  currentDrillId = emptySessionId;
  activeDrills = [];

  // Store empty session
  drillSessions[emptySessionId] = {
    sessionId: null,
    drillType: emptySessionId,
    activeDrills: [],
    messages: []
  };

  // Open the chat modal
  const modal = document.getElementById('chat-modal');
  const messagesContainer = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('chat-send-btn');

  // Show modal
  modal.classList.remove('hidden');

  // Update title
  updateChatTitle();

  // Update badges
  updateActiveDrillsBadges();

  // Clear messages and show welcome
  messagesContainer.innerHTML = '';
  const welcomeMessage = document.createElement('div');
  welcomeMessage.className = 'flex justify-center my-8';
  welcomeMessage.innerHTML = `
    <div class="text-center p-6 bg-slate-50 rounded-lg max-w-md">
      <h3 class="text-xl font-semibold text-slate-900 mb-3">Empty Session Started</h3>
      <p class="text-slate-600 mb-4">No drills are currently active. Click the "+ Add Drill" button above to add drills and start practicing.</p>
      <p class="text-sm text-slate-500">You can add multiple drills to practice them together with random alternation.</p>
    </div>
  `;
  messagesContainer.appendChild(welcomeMessage);

  // Disable input until a drill is added
  chatInput.disabled = true;
  sendButton.disabled = true;
  chatInput.placeholder = 'Add a drill to continue...';

  // Add enter key handler
  chatInput.onkeypress = function(e) {
    if (e.key === 'Enter') {
      sendChatMessage();
    }
  };
}

async function openDrillChat(drillId) {
  
  // Detect if we're switching drill types BEFORE updating currentDrillId
  const previousDrillId = currentDrillId;
  const isSwitchingDrillTypes = previousDrillId && previousDrillId !== drillId;
  
  // If switching to different drill type, reset current session
  if (isSwitchingDrillTypes) {
    currentChatSession = null;
  }
  
  const modal = document.getElementById('chat-modal');
  const messagesContainer = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('chat-send-btn');
  const loadingMessage = document.getElementById('loading-message');
  
  // Show modal
  modal.classList.remove('hidden');
  
  // Update current drill and set title
  currentDrillId = drillId;
  const drillTitle = document.getElementById('chat-drill-title');
  
  // Set appropriate title based on drill ID
  switch(drillId) {
    case 'regular-ar':
      drillTitle.textContent = 'Regular -ar Verb Drill';
      break;
    case 'regular-er':
      drillTitle.textContent = 'Regular -er Verb Drill';
      break;
    case 'regular-ir':
      drillTitle.textContent = 'Regular -ir Verb Drill';
      break;
    case 'irregular-verbs':
      drillTitle.textContent = 'Irregular Verbs Drill';
      break;
    case 'ser-estar':
      drillTitle.textContent = 'Ser vs. Estar Drill';
      break;
    case 'ir-transportation':
      drillTitle.textContent = 'Ir + Transportation Drill';
      break;
    case 'contractions-articles':
      drillTitle.textContent = 'Contractions with Articles (de/em)';
      break;
    case 'reflexive-verbs':
      drillTitle.textContent = 'Reflexive Verbs Drill';
      break;
    case 'immediate-future':
      drillTitle.textContent = 'Immediate Future Drill';
      break;
    case 'present-continuous':
      drillTitle.textContent = 'Present Continuous Tense Drill';
      break;
    case 'imperfect-tense':
      drillTitle.textContent = 'Imperfect Tense Drill';
      break;
    case 'future-tense':
      drillTitle.textContent = 'Future Tense Drill';
      break;
    case 'conditional-tense':
      drillTitle.textContent = 'Conditional Tense Drill';
      break;
    case 'present-subjunctive':
      drillTitle.textContent = 'Present Subjunctive Drill';
      break;
    case 'imperfect-subjunctive':
      drillTitle.textContent = 'Imperfect Subjunctive Drill';
      break;
    case 'future-subjunctive':
      drillTitle.textContent = 'Future Subjunctive Drill';
      break;
    case 'imperative':
      drillTitle.textContent = 'Imperative Drill';
      break;
    case 'noun-plurals':
      drillTitle.textContent = 'Noun Plural Tutor';
      break;
    case 'adjective-agreement':
      drillTitle.textContent = 'Adjective Gender & Number Agreement';
      break;
    case 'demonstratives':
      drillTitle.textContent = 'Demonstrative Pronouns Drill';
      break;
    case 'advanced-demonstratives':
      drillTitle.textContent = 'Advanced Demonstratives Drill';
      break;
    case 'crase':
      drillTitle.textContent = 'Crase (Ã ) Tutor';
      break;
    case 'contractions-de':
      drillTitle.textContent = 'Contraction Trainer (dele/dela)';
      break;
    case 'contractions-em':
      drillTitle.textContent = 'Contraction Trainer (nele/nela)';
      break;
    case 'syllable-stress':
      drillTitle.textContent = 'Syllable Stress Drill';
      break;
    case 'phonetics-br':
      drillTitle.textContent = 'Brazilian Portuguese Phonetics Tutor';
      break;
    case 'colloquial-speech':
      drillTitle.textContent = 'Colloquial Speech Drill';
      break;
    case 'conversational-answers':
      drillTitle.textContent = 'Conversational Answers Drill';
      break;
    case 'self-introduction':
      drillTitle.textContent = 'Self-Introduction Drill';
      break;
    case 'portuguese-for-spanish':
      drillTitle.textContent = 'Portuguese for Spanish Speakers';
      break;
    case 'por-vs-para':
      drillTitle.textContent = 'Por vs Para';
      break;
    case 'placement-test':
      drillTitle.textContent = 'Portuguese Diagnostic Test';
      break;
    default:
      drillTitle.textContent = 'Portuguese Drill';
  }
  
  console.log('ðŸ”¥ After setting currentDrillId to:', currentDrillId);
  console.log('ðŸ”¥ Looking for existing session with key:', drillId);
  console.log('ðŸ”¥ drillSessions[drillId]:', drillSessions[drillId]);
  console.log('ðŸ”¥ All drillSessions keys:', Object.keys(drillSessions));
  
  // Safety check: If stored session doesn't match drill type, clear it
  if (drillSessions[drillId] && drillSessions[drillId].drillType !== drillId) {
    console.log('ðŸ”¥ WARNING: Session drill type mismatch! Clearing corrupted session.');
    console.log('ðŸ”¥ Expected:', drillId, 'but found:', drillSessions[drillId].drillType);
    delete drillSessions[drillId];
  }
  
  // IMPORTANT: Only restore session if it's for the EXACT same drill type
  // and the stored session actually has the correct drill type
  // AND we're not switching from a different drill type
  console.log('ðŸ”¥ isSwitchingDrillTypes:', isSwitchingDrillTypes);
  
  // Only create fresh session if we're switching to a DIFFERENT drill type
  // If we're returning to the same drill type, restore the session
  const shouldRestoreSession = drillSessions[drillId] && drillSessions[drillId].drillType === drillId;
  console.log('ðŸ”¥ shouldRestoreSession:', shouldRestoreSession);
  
  if (shouldRestoreSession) {
    console.log('ðŸ”¥ Found existing session for:', drillId);
    console.log('ðŸ”¥ Session details:', drillSessions[drillId]);
    console.log('ðŸ”¥ Restoring session...');
    // Restore existing session
    currentChatSession = drillSessions[drillId].sessionId;
    activeDrills = drillSessions[drillId].activeDrills || [drillId]; // Restore activeDrills
    messagesContainer.innerHTML = '';

    // Restore all messages from this session
    drillSessions[drillId].messages.forEach(msg => {
      addMessageToChat(msg.role === 'user' ? 'user' : 'ai', msg.content);
    });

    // Update drill badges display
    updateActiveDrillsBadges();

    // Update the chat title
    updateChatTitle();

    // Enable input
    chatInput.disabled = false;
    sendButton.disabled = false;

    // Add enter key handler
    chatInput.onkeypress = function(e) {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    };

    return;
  } else {
    console.log('ðŸ”¥ No existing session found for:', drillId, 'or switching drill types');
    console.log('ðŸ”¥ Creating new session...');
  }
  
  // Disable input while starting new session
  chatInput.disabled = true;
  sendButton.disabled = true;
  
  // Show loading message with spinner
  messagesContainer.innerHTML = `
    <div class="flex items-start space-x-3">
      <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
        <span class="text-green-600 text-sm font-bold">AI</span>
      </div>
      <div class="bg-slate-100 rounded-2xl p-3 max-w-2xl">
        <div class="flex items-center gap-3">
          <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-600"></div>
          <div id="loading-message" class="text-slate-600">Starting your drill session...</div>
        </div>
        <div class="text-xs text-slate-500 mt-2">This may take up to 30 seconds...</div>
      </div>
    </div>
  `;

  console.log('ðŸ”¥ Set loading message and disabled input');
  
  try {
    // Start new chat session with timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
    
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        drillId: drillId,
        isNewSession: true
      }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      const errorMessage = errorData.error || `HTTP error! status: ${response.status}`;
      throw new Error(errorMessage);
    }

    const data = await response.json();
    currentChatSession = data.sessionId;

    // Initialize activeDrills array with the first drill
    activeDrills = [drillId];

    // Store new session data
    drillSessions[drillId] = {
      sessionId: data.sessionId,
      drillType: drillId, // Explicitly store the drill type
      activeDrills: [drillId], // Track active drills
      messages: [{ role: 'assistant', content: data.response }]
    };

    console.log('ðŸ”¥ Created new session for drillId:', drillId);
    console.log('ðŸ”¥ Session data:', drillSessions[drillId]);
    console.log('ðŸ”¥ All sessions now:', JSON.stringify(drillSessions, null, 2));
    
    // Clear loading and show AI response
    messagesContainer.innerHTML = '';
    addMessageToChat('ai', data.response);

    // Update drill badges display
    updateActiveDrillsBadges();

    // Update the chat title
    updateChatTitle();

    // Enable input
    chatInput.disabled = false;
    sendButton.disabled = false;

    // Add enter key handler
    chatInput.onkeypress = function(e) {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    };
    
  } catch (error) {
    console.error('Error starting chat session:', error);

    // Clear loading and show error
    messagesContainer.innerHTML = '';

    const errorDiv = document.createElement('div');
    errorDiv.className = 'flex items-start space-x-3';
    errorDiv.innerHTML = `
      <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
        <span class="text-red-600 text-sm font-bold">âš ï¸</span>
      </div>
      <div class="bg-red-50 border border-red-200 rounded-2xl p-4 max-w-2xl">
        <div class="text-red-800 font-semibold mb-2">Failed to Start Session</div>
        <div class="text-red-700 text-sm mb-3">
          ${error.name === 'AbortError'
            ? 'The request timed out after 30 seconds. The AI service might be experiencing heavy load.'
            : error.message.includes('Failed to fetch')
            ? 'Network error: Could not connect to the server. Please check your internet connection.'
            : 'Sorry, there was an error starting the session: ' + error.message}
        </div>
        <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg text-sm transition-colors">
          Reload Page
        </button>
      </div>
    `;
    messagesContainer.appendChild(errorDiv);

    // Re-enable input in case user wants to try again
    chatInput.disabled = false;
    sendButton.disabled = false;
  }
}

// Filter out completion messages from AI responses
function filterCompletionMessages(response) {
  if (!response) return { text: response, needsNextQuestion: false };

  // Patterns that indicate completion/summary messages
  const completionPatterns = [
    /ðŸŽ‰\s*Congratulations!/i,
    /ðŸŽŠ\s*Congratulations!/i,
    /You've completed/i,
    /You've finished/i,
    /Great job! You've/i,
    /\n\s*Summary:/i,
    /Here's a quick summary:/i,
    /You got all the answers correct!/i,
    /Would you like to:/i,
    /Would you like to practice more/i,
    /move on to another topic/i,
    /practice more or move on/i,
  ];

  // Check if response contains completion patterns
  let hasCompletionMessage = false;
  let cutoffIndex = -1;

  for (const pattern of completionPatterns) {
    const match = response.match(pattern);
    if (match) {
      hasCompletionMessage = true;
      // Find the earliest cutoff point
      if (cutoffIndex === -1 || match.index < cutoffIndex) {
        cutoffIndex = match.index;
      }
    }
  }

  // If completion message detected, cut it off
  if (hasCompletionMessage && cutoffIndex > 0) {
    // Keep everything before the completion message
    let filtered = response.substring(0, cutoffIndex).trim();

    // Remove trailing separators
    filtered = filtered.replace(/---\s*$/m, '').trim();

    console.log('ðŸš« Filtered out completion message');

    // Check if the filtered response contains a question
    const hasQuestion = /\?/.test(filtered) || /\[CHIPS/.test(filtered) || /____/.test(filtered);

    return {
      text: filtered,
      needsNextQuestion: !hasQuestion
    };
  }

  return { text: response, needsNextQuestion: false };
}

async function sendChatMessage(retryMessage = null, silent = false) {
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('chat-send-btn');
  const message = retryMessage || chatInput.value.trim();

  if (!message || !currentChatSession) return;

  let userMessageDiv = null;

  // Randomly select drill FIRST (before storing any messages)
  // This ensures we use consistent drill for: user message storage, history fetch, AI response storage
  const selectedDrill = activeDrills.length > 0
      ? activeDrills[Math.floor(Math.random() * activeDrills.length)]
      : currentDrillId;

  console.log('ðŸŽ² Randomly selected drill:', selectedDrill, 'from', activeDrills);


  // Only add user message if this is not a retry and not silent
  if (!retryMessage && !silent) {
    userMessageDiv = addMessageToChat('user', message);

    // Store user message in session history
    if (selectedDrill && drillSessions[selectedDrill]) {
      drillSessions[selectedDrill].messages.push({ role: 'user', content: message });
    }

    // Clear input and disable while processing
    chatInput.value = '';
  } else if (silent) {
    // For silent messages, still store in history but don't display
    if (selectedDrill && drillSessions[selectedDrill]) {
      drillSessions[selectedDrill].messages.push({ role: 'user', content: message });
    }
  }

  chatInput.disabled = true;
  sendButton.disabled = true;

  // Show typing indicator
  const typingIndicator = addMessageToChat('ai', '...');

  try {

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 second timeout for mobile

    // Get message history for stateless fallback
    const messageHistory = drillSessions[selectedDrill]?.messages || [];

    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        sessionId: currentChatSession,
        drillId: selectedDrill,
        message: message,
        messages: messageHistory
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text().catch(() => 'Unknown error');
      throw new Error(`Server error (${response.status}): ${errorText}`);
    }

    const data = await response.json();

    // Filter out completion messages before displaying
    const filterResult = filterCompletionMessages(data.response);

    // Remove typing indicator and add real response
    typingIndicator.remove();
    addMessageToChat('ai', filterResult.text);

    // Store AI response in session history
    if (selectedDrill && drillSessions[selectedDrill]) {
      drillSessions[selectedDrill].messages.push({ role: 'assistant', content: filterResult.text });
    }

    // If we filtered out a completion and there's no question, request the next question
    if (filterResult.needsNextQuestion) {
      console.log('ðŸ”„ Requesting next question after completion filter');
      // Send a silent message to request the next question
      setTimeout(() => {
        sendChatMessage('Please give me the next question.', true);
      }, 500);
    }

  } catch (error) {
    console.error('Error sending message:', error);

    // Remove typing indicator
    typingIndicator.remove();

    // Determine error type
    let errorMessage = 'Connection error. ';
    if (error.name === 'AbortError') {
      errorMessage = 'Request timed out. ';
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'Network error. Check your connection. ';
    } else if (error.message.includes('Server error')) {
      errorMessage = error.message + ' ';
    }

    // Show error with retry button
    const errorDiv = document.createElement('div');
    errorDiv.className = 'flex justify-center my-4';
    errorDiv.innerHTML = `
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 max-w-md">
        <p class="text-red-800 text-sm mb-3">${errorMessage}</p>
        <button
          onclick="retrySendMessage('${escapeForJs(message)}')"
          class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition-colors text-sm"
        >
          Retry Message
        </button>
      </div>
    `;

    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.appendChild(errorDiv);
    smartScrollToBottom(messagesContainer, true); // Force scroll for error messages

  } finally {
    // Re-enable input
    chatInput.disabled = false;
    sendButton.disabled = false;
  }
}

// Retry function
function retrySendMessage(message) {
  sendChatMessage(message);
}

// Smart scroll function - only scrolls if user is near the bottom
function smartScrollToBottom(container, force = false) {
  if (!container) return;

  const threshold = 150; // pixels from bottom
  const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < threshold;

  // Always scroll for user messages, or if user is already near bottom, or if forced
  if (force || isNearBottom) {
    container.scrollTop = container.scrollHeight;
  }
}

function addMessageToChat(sender, content) {
  const messagesContainer = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'flex items-start space-x-3';

  if (sender === 'user') {
    messageDiv.className += ' justify-end';
    messageDiv.innerHTML = `
      <div class="bg-green-600 text-white rounded-2xl p-3 max-w-2xl">
        <div class="message-content">${escapeHtml(content)}</div>
      </div>
      <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
        <span class="text-blue-600 text-sm font-bold">You</span>
      </div>
    `;
  } else {
    // Remove [CHIPS: ...] marker from displayed message (if answerChips.js is loaded)
    const displayContent = typeof removeChipsMarker === 'function'
      ? removeChipsMarker(content)
      : content.replace(/\[CHIPS(-ROW[12])?:\s*[^\]]+\]/gi, '').trim();

    messageDiv.innerHTML = `
      <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
        <span class="text-green-600 text-sm font-bold">AI</span>
      </div>
      <div class="bg-slate-100 rounded-2xl p-3 max-w-2xl">
        <div class="message-content">${formatAIMessage(displayContent)}</div>
      </div>
    `;
  }

  messagesContainer.appendChild(messageDiv);

  // Add conjugation buttons if this is a question in verb drills
  if (sender === 'ai' && shouldShowConjugationButtons(content, activeDrills)) {
    addConjugationButtons(messagesContainer, content, activeDrills);
  }
  // Add answer chips if the message contains answer options
  else if (sender === 'ai' && shouldShowAnswerChips(content, activeDrills)) {
    addAnswerChips(messagesContainer, content);
  }

  // Smart scroll: force scroll for user messages, conditional for AI messages
  smartScrollToBottom(messagesContainer, sender === 'user');

  return messageDiv;
}

function formatAIMessage(content) {
  // Convert line breaks to <br> and preserve formatting
  return escapeHtml(content)
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
    .replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italic text
}

function closeDrillChat() {
  const modal = document.getElementById('chat-modal');
  modal.classList.add('hidden');
  currentChatSession = null;

  // Reset maximize state when closing
  const container = document.getElementById('chat-container');
  if (container.classList.contains('max-w-full')) {
    toggleMaximizeChat();
  }
}

function toggleMaximizeChat() {
  const container = document.getElementById('chat-container');
  const maximizeIcon = document.getElementById('maximize-icon');
  const minimizeIcon = document.getElementById('minimize-icon');
  const modal = document.getElementById('chat-modal');

  // Toggle between normal and maximized states
  if (container.classList.contains('max-w-3xl')) {
    // Maximize
    container.classList.remove('max-w-3xl', 'h-[90vh]', 'rounded-2xl');
    container.classList.add('max-w-full', 'h-full', 'rounded-none');
    modal.classList.remove('p-2');
    modal.classList.add('p-0');

    // Swap icons
    maximizeIcon.classList.add('hidden');
    minimizeIcon.classList.remove('hidden');
  } else {
    // Minimize (restore to normal)
    container.classList.remove('max-w-full', 'h-full', 'rounded-none');
    container.classList.add('max-w-3xl', 'h-[90vh]', 'rounded-2xl');
    modal.classList.remove('p-0');
    modal.classList.add('p-2');

    // Swap icons
    maximizeIcon.classList.remove('hidden');
    minimizeIcon.classList.add('hidden');
  }
}

// Copy shareable link for a specific drill
async function copyDrillLink(drillId, buttonElement) {
  const baseUrl = window.location.origin + window.location.pathname;
  const shareableUrl = `${baseUrl}?drill=${drillId}`;

  try {
    await navigator.clipboard.writeText(shareableUrl);

    // Visual feedback
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = 'âœ“ Copied!';
    buttonElement.classList.add('bg-purple-600');
    buttonElement.classList.remove('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');

    // Reset after 2 seconds
    setTimeout(() => {
      buttonElement.innerHTML = originalText;
      buttonElement.classList.remove('bg-purple-600');
      buttonElement.classList.add('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
    }, 2000);
  } catch (err) {
    console.error('Failed to copy link:', err);
    // Fallback: show the URL in an alert
    alert(`Copy this link:\n${shareableUrl}`);
  }
}

// Share current chat state with all active drills
async function shareChatState(buttonElement) {
  const baseUrl = window.location.origin + window.location.pathname;

  // Get all active drills from the current session
  if (!activeDrills || activeDrills.length === 0) {
    alert('No active drills to share. Please add a drill first.');
    return;
  }

  // Create URL with comma-separated drill IDs
  const drillsParam = activeDrills.join(',');
  const shareableUrl = `${baseUrl}?drills=${drillsParam}`;

  try {
    await navigator.clipboard.writeText(shareableUrl);

    // Visual feedback
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = 'âœ“ Copied!';
    buttonElement.classList.add('bg-purple-800', 'text-white');
    buttonElement.classList.remove('text-purple-600', 'hover:text-purple-700');

    // Reset after 2 seconds
    setTimeout(() => {
      buttonElement.innerHTML = originalText;
      buttonElement.classList.remove('bg-purple-800', 'text-white');
      buttonElement.classList.add('text-purple-600', 'hover:text-purple-700');
    }, 2000);
  } catch (err) {
    console.error('Failed to copy chat link:', err);
    // Fallback: show the URL in an alert
    alert(`Copy this link:\n${shareableUrl}`);
  }
}

// Drill selector functions
function openDrillSelector() {
  const modal = document.getElementById('drill-selector-modal');
  const listContainer = document.getElementById('drill-selector-list');

  // Get all drill cards that have integrated chat support
  const drillCards = document.querySelectorAll('.drill-card');
  const drillsWithIntegration = [];

  drillCards.forEach(card => {
    const integratedButton = card.querySelector('button[onclick^="openDrillChat"]');
    if (integratedButton) {
      const drillId = card.id.replace('drill-', '');
      const titleElement = card.querySelector('h2');
      const descriptionElement = card.querySelector('p.text-slate-600');
      const categoryElement = card.querySelector('span.inline-block');

      if (titleElement && !activeDrills.includes(drillId)) {
        drillsWithIntegration.push({
          id: drillId,
          title: titleElement.textContent.trim(),
          description: descriptionElement ? descriptionElement.textContent.trim() : '',
          category: categoryElement ? categoryElement.textContent.trim() : ''
        });
      }
    }
  });

  // Build the drill list HTML
  if (drillsWithIntegration.length === 0) {
    listContainer.innerHTML = '<p class="text-slate-500 text-center py-8">No other drills available to add.</p>';
  } else {
    listContainer.innerHTML = drillsWithIntegration.map(drill => `
      <button onclick="addDrillToChat('${drill.id}')" class="w-full text-left p-4 rounded-lg border border-slate-200 hover:border-green-500 hover:bg-green-50 transition-all">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h3 class="font-semibold text-slate-900 mb-1">${escapeHtml(drill.title)}</h3>
            ${drill.category ? `<span class="inline-block text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 mb-2">${escapeHtml(drill.category)}</span>` : ''}
            <p class="text-sm text-slate-600">${escapeHtml(drill.description)}</p>
          </div>
          <svg class="w-5 h-5 text-green-600 flex-shrink-0 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
        </div>
      </button>
    `).join('');
  }

  modal.classList.remove('hidden');
}

function closeDrillSelector() {
  const modal = document.getElementById('drill-selector-modal');
  modal.classList.add('hidden');
}

async function addDrillToChat(drillId) {
  // Check if drill is already active
  if (activeDrills.includes(drillId)) {
    alert('This drill is already active in the current session.');
    closeDrillSelector();
    return;
  }

  closeDrillSelector();

  const messagesContainer = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('chat-send-btn');

  // Disable input while adding drill
  chatInput.disabled = true;
  sendButton.disabled = true;

  // Add a system message
  const systemMessage = document.createElement('div');
  systemMessage.className = 'flex justify-center my-2';
  systemMessage.innerHTML = `
    <div class="bg-blue-100 text-blue-800 text-sm px-4 py-2 rounded-full">
      Adding drill to session...
    </div>
  `;
  messagesContainer.appendChild(systemMessage);
  smartScrollToBottom(messagesContainer, false); // Don't force scroll for system messages

  try {
    // If this is an empty session (no currentChatSession), start a new session with this drill
    if (!currentChatSession) {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          drillId: drillId,
          isNewSession: true
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      currentChatSession = data.sessionId;

      // Add the drill to activeDrills array
      activeDrills.push(drillId);

      // Update the session's active drills
      if (drillSessions[currentDrillId]) {
        drillSessions[currentDrillId].sessionId = data.sessionId;
        drillSessions[currentDrillId].activeDrills = [...activeDrills];
        drillSessions[currentDrillId].messages.push(
          { role: 'assistant', content: data.response }
        );
      }

      // Update the badges display
      updateActiveDrillsBadges();

      // Update the chat title
      updateChatTitle();

      // Remove system message and add AI response
      systemMessage.remove();
      addMessageToChat('ai', data.response);

      // Enable input and restore placeholder
      chatInput.disabled = false;
      sendButton.disabled = false;
      chatInput.placeholder = 'Type your answer...';
  
      return;
    }

    // Send a message to add the drill to existing session
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: currentChatSession,
        message: `[SYSTEM: User wants to add the "${drillId}" drill to this conversation. From now on, alternate between the active drills. Acknowledge this briefly and provide the first exercise for this new drill.]`,
        drillType: drillId
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();

    // Add the drill to activeDrills array
    activeDrills.push(drillId);

    // Update the session's active drills
    if (drillSessions[currentDrillId]) {
      drillSessions[currentDrillId].activeDrills = [...activeDrills];
      drillSessions[currentDrillId].messages.push(
        { role: 'user', content: `[Added drill: ${drillId}]` },
        { role: 'assistant', content: data.response }
      );
    }

    // Update the badges display
    updateActiveDrillsBadges();

    // Update the chat title
    updateChatTitle();

    // Remove system message and add AI response
    systemMessage.remove();
    addMessageToChat('ai', data.response);

    // Enable input and restore placeholder
    chatInput.disabled = false;
    sendButton.disabled = false;
    chatInput.placeholder = 'Type your answer...';

  } catch (error) {
    console.error('Error adding drill:', error);
    systemMessage.innerHTML = `
      <div class="bg-red-100 text-red-800 text-sm px-4 py-2 rounded-full">
        Failed to add drill. Please try again.
      </div>
    `;
    chatInput.disabled = false;
    sendButton.disabled = false;
  }
}

async function removeDrillFromChat(drillId) {
  if (!currentChatSession) {
    return;
  }

  // Remove drill from activeDrills array
  const index = activeDrills.indexOf(drillId);
  if (index === -1) {
    return; // Drill not found
  }

  activeDrills.splice(index, 1);

  // Update the session's active drills
  if (drillSessions[currentDrillId]) {
    drillSessions[currentDrillId].activeDrills = [...activeDrills];
  }

  // Update the badges display
  updateActiveDrillsBadges();

  // Update the chat title
  updateChatTitle();

  // Add a system message to the chat
  const messagesContainer = document.getElementById('chat-messages');
  const systemMessage = document.createElement('div');
  systemMessage.className = 'flex justify-center my-2';
  systemMessage.innerHTML = `
    <div class="bg-slate-100 text-slate-600 text-xs px-3 py-1.5 rounded-full">
      Removed "${getDrillName(drillId)}" from active drills
    </div>
  `;
  messagesContainer.appendChild(systemMessage);
  smartScrollToBottom(messagesContainer, false); // Don't force scroll for system messages

  // If no drills remain, disable input and show message
  if (activeDrills.length === 0) {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('chat-send-btn');
    chatInput.disabled = true;
    sendButton.disabled = true;
    chatInput.placeholder = 'Add a drill to continue...';

    // Add empty state message
    const emptyMessage = document.createElement('div');
    emptyMessage.className = 'flex justify-center my-4';
    emptyMessage.innerHTML = `
      <div class="text-center p-4 bg-slate-50 rounded-lg max-w-md">
        <p class="text-slate-600 mb-2">All drills have been removed.</p>
        <p class="text-sm text-slate-500">Click the "+ Add Drill" button to add drills and continue practicing.</p>
      </div>
    `;
    messagesContainer.appendChild(emptyMessage);
    smartScrollToBottom(messagesContainer, false); // Don't force scroll for system messages
  }
}

function updateActiveDrillsBadges() {
  const container = document.getElementById('active-drills-container');
  const badgesContainer = document.getElementById('active-drills-badges');

  if (activeDrills.length === 0) {
    // Show empty state message
    container.classList.remove('hidden');
    badgesContainer.innerHTML = `
      <span class="text-xs text-slate-500 italic">No drills loaded. Click "+ Add Drill" to start practicing.</span>
    `;
    return;
  }

  // Show container and populate badges with remove buttons
  container.classList.remove('hidden');
  badgesContainer.innerHTML = activeDrills.map(drillId => {
    const drillName = getDrillName(drillId);
    return `
      <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
        ${escapeHtml(drillName)}
        <button
          onclick="removeDrillFromChat('${drillId}')"
          class="hover:bg-green-200 rounded-full p-0.5 transition-colors"
          title="Remove this drill"
        >
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </span>
    `;
  }).join('');
}

function getDrillName(drillId) {
  const names = {
    'ar-verbs': 'Regular -ar Verbs',
    'er-verbs': 'Regular -er Verbs',
    'ir-verbs': 'Regular -ir Verbs',
    'irregular-verbs': 'Irregular Verbs',
    'ser-estar': 'Ser vs. Estar',
    'reflexive-verbs': 'Reflexive Verbs',
    'immediate-future': 'Immediate Future',
    'present-continuous': 'Present Continuous',
    'imperfect-tense': 'Imperfect Tense',
    'future-tense': 'Future Tense',
    'conditional-tense': 'Conditional Tense',
    'present-subjunctive': 'Present Subjunctive',
    'imperfect-subjunctive': 'Imperfect Subjunctive',
    'future-subjunctive': 'Future Subjunctive',
    'imperative': 'Imperative',
    'noun-plurals': 'Noun Plurals',
    'adjective-agreement': 'Adjective Agreement',
    'demonstratives': 'Demonstratives',
    'ir-transportation': 'Ir + Transportation',
    'advanced-demonstratives': 'Advanced Demonstratives',
    'crase': 'Crase (Ã )',
    'contractions-de': 'Contractions (de)',
    'contractions-em': 'Contractions (em)',
    'contractions-articles': 'Contractions with Articles',
    'syllable-stress': 'Syllable Stress',
    'phonetics-br': 'Phonetics',
    'colloquial-speech': 'Colloquial Speech',
    'conversational-answers': 'Conversational Answers',
    'self-introduction': 'Self-Introduction',
    'portuguese-for-spanish': 'PT for Spanish'
  };
  return names[drillId] || drillId;
}

function updateChatTitle() {
  const drillTitleContainer = document.getElementById('chat-drill-title');

  if (activeDrills.length === 0) {
    drillTitleContainer.textContent = 'No drills active';
    return;
  }

  if (activeDrills.length === 1) {
    drillTitleContainer.textContent = getDrillName(activeDrills[0]);
    return;
  }

  // Multiple drills - show as a list
  const drillNames = activeDrills.map(id => getDrillName(id));
  drillTitleContainer.textContent = drillNames.join(' â€¢ ');
}
    </script>
    <script src="/js/utils.js?v=1761210000000"></script>
    <script src="/js/conjugations.js?v=1761210000000"></script>
    <script src="/js/answerChips.js?v=1761210000000"></script>
    <script src="/js/dependencies.js?v=1761210000000"></script>
    <!-- LZ-String for placement test hash compression -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="/js/placementTest.js?v=1761210000000"></script>

    <!-- Route detection for direct /placement-test access -->
    <script>
      (function() {
        const path = window.location.pathname;
        if (path === '/placement-test' || path === '/placement-test/') {
          // Hide body content immediately
          document.addEventListener('DOMContentLoaded', () => {
            // Hide all main content
            const containers = document.querySelectorAll('.container');
            containers.forEach(el => el.style.display = 'none');

            const footer = document.querySelector('footer');
            if (footer) footer.style.display = 'none';

            const header = document.querySelector('header');
            if (header) header.style.display = 'none';

            // Hide all sections
            const sections = document.querySelectorAll('section');
            sections.forEach(el => el.style.display = 'none');
          });

          // Start placement test when function is available
          window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
              if (typeof startPlacementTest === 'function') {
                startPlacementTest();
              } else {
                console.error('startPlacementTest function not found');
              }
            }, 200);
          });
        }
      })();
    </script>

    <!-- Pronunciation Annotator Engine -->
    <script src="/js/pronunciation-annotator.js"></script>    <!-- PWA Setup -->    <script src="/pwa-setup.js"></script>
</body>
</html>
